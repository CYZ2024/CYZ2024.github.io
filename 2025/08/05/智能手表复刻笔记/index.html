<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æ•´ä½“æ¡†æ¶ ç¡¬ä»¶ç»“æ„ ç³»ç»Ÿç»„æˆ ä¸»æ§ä½¿ç”¨ STM32F411CEU6ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ FreeRTOSï¼Œå›¾å½¢åº“ä½¿ç”¨çš„ LVGLã€‚ä¼ æ„Ÿå™¨éƒ¨åˆ†ï¼šæ‰‹åŠ¿è¯†åˆ«ä½¿ç”¨ 6 è½´ MPU6050ï¼›å¿ƒç‡è¡€æ°§ä½¿ç”¨çš„æ˜¯ EM7028ï¼›æµ·æ‹”æµ‹é‡ç”¨çš„æ°”å‹è®¡ SPL06-001ï¼›ç”µå­æŒ‡å—é’ˆä½¿ç”¨ LSM303DLHCï¼›è“ç‰™èŠ¯ç‰‡ç”¨çš„ KT6368Aï¼Œæœ‰ SPP åŠŸèƒ½ï¼Œå¯ä»¥æ— çº¿å‡çº§ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="æ™ºèƒ½æ‰‹è¡¨å¤åˆ»ç¬”è®°">
<meta property="og:url" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="CYZçš„ä¸ªäººåšå®¢">
<meta property="og:description" content="æ•´ä½“æ¡†æ¶ ç¡¬ä»¶ç»“æ„ ç³»ç»Ÿç»„æˆ ä¸»æ§ä½¿ç”¨ STM32F411CEU6ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ FreeRTOSï¼Œå›¾å½¢åº“ä½¿ç”¨çš„ LVGLã€‚ä¼ æ„Ÿå™¨éƒ¨åˆ†ï¼šæ‰‹åŠ¿è¯†åˆ«ä½¿ç”¨ 6 è½´ MPU6050ï¼›å¿ƒç‡è¡€æ°§ä½¿ç”¨çš„æ˜¯ EM7028ï¼›æµ·æ‹”æµ‹é‡ç”¨çš„æ°”å‹è®¡ SPL06-001ï¼›ç”µå­æŒ‡å—é’ˆä½¿ç”¨ LSM303DLHCï¼›è“ç‰™èŠ¯ç‰‡ç”¨çš„ KT6368Aï¼Œæœ‰ SPP åŠŸèƒ½ï¼Œå¯ä»¥æ— çº¿å‡çº§ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/I2C.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/MPU6050.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/Pin.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/SPL06-001.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/compass.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/heartrate_pin.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/heart_rate.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/ble.png">
<meta property="og:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/KT6368A.png">
<meta property="og:image" content="https://no-chicken.com/images/OV-Watch/3/Charge.jpg">
<meta property="article:published_time" content="2025-08-05T03:31:43.000Z">
<meta property="article:modified_time" content="2025-08-11T14:30:54.000Z">
<meta property="article:author" content="CYZ">
<meta property="article:tag" content="å¤åˆ»">
<meta property="article:tag" content="STM32">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/I2C.png">

<link rel="canonical" href="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>æ™ºèƒ½æ‰‹è¡¨å¤åˆ»ç¬”è®° | CYZçš„ä¸ªäººåšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CYZçš„ä¸ªäººåšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/chino2.jpg">
      <meta itemprop="name" content="CYZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYZçš„ä¸ªäººåšå®¢">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          æ™ºèƒ½æ‰‹è¡¨å¤åˆ»ç¬”è®°
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-05 11:31:43" itemprop="dateCreated datePublished" datetime="2025-08-05T11:31:43+08:00">2025-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-11 22:30:54" itemprop="dateModified" datetime="2025-08-11T22:30:54+08:00">2025-08-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å¤åˆ»ç¬”è®°</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="æ•´ä½“æ¡†æ¶">æ•´ä½“æ¡†æ¶</h1>
<h2 id="ç¡¬ä»¶ç»“æ„">ç¡¬ä»¶ç»“æ„</h2>
<h3 id="ç³»ç»Ÿç»„æˆ">ç³»ç»Ÿç»„æˆ</h3>
<p>ä¸»æ§ä½¿ç”¨ STM32F411CEU6ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ FreeRTOSï¼Œå›¾å½¢åº“ä½¿ç”¨çš„
LVGLã€‚ä¼ æ„Ÿå™¨éƒ¨åˆ†ï¼šæ‰‹åŠ¿è¯†åˆ«ä½¿ç”¨ 6 è½´ MPU6050ï¼›å¿ƒç‡è¡€æ°§ä½¿ç”¨çš„æ˜¯
EM7028ï¼›æµ·æ‹”æµ‹é‡ç”¨çš„æ°”å‹è®¡ SPL06-001ï¼›ç”µå­æŒ‡å—é’ˆä½¿ç”¨
LSM303DLHCï¼›è“ç‰™èŠ¯ç‰‡ç”¨çš„ KT6368Aï¼Œæœ‰ SPP åŠŸèƒ½ï¼Œå¯ä»¥æ— çº¿å‡çº§ã€‚</p>
<p><img
src="https://no-chicken.com/images/OV-Watch/0/%E6%A1%86%E5%9B%BE.png" /></p>
<span id="more"></span>
<p><em>å¤„äºå¤åˆ»ç›®çš„ï¼Œä»¥ä¸‹è®²è¯¦ç»†è§£é‡Šæ¯ä¸€ä¸ªèŠ¯ç‰‡å¼•è„šé…ç½®ä»¥åŠç”µè·¯è¿æ¥</em></p>
<h3 id="ä¾›ç”µéƒ¨åˆ†">ä¾›ç”µéƒ¨åˆ†</h3>
<h3 id="å……ç”µéƒ¨åˆ†">å……ç”µéƒ¨åˆ†</h3>
<h3 id="i2c-æ€»çº¿">I2C æ€»çº¿</h3>
<p>ä¼ æ„Ÿå™¨ç»Ÿä¸€æ”¾åœ¨èƒŒæ¿ï¼ŒæŒ‚è½½åœ¨åŒä¸€ä¸ª IIC æ€»çº¿ä¸Š</p>
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/I2C.png" class="" title="I2Cæ€»çº¿">
<h3 id="mpu-6050">MPU-6050</h3>
<p>è½´è¿åŠ¨è·Ÿè¸ªè®¾å¤‡ï¼Œé›†æˆ 3 è½´é™€èºä»ªã€3
è½´åŠ é€Ÿåº¦è®¡åŠæ•°å­—è¿åŠ¨å¤„ç†å™¨ï¼ˆDMPï¼‰ï¼Œé‡‡ç”¨ 4x4x0.9mm QFN å°è£…ï¼Œæ”¯æŒ 9
è½´ä¼ æ„Ÿå™¨èåˆã€‚</p>

<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/MPU6050.png" class="" title="MPU6050">
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/Pin.png" class="" title="å„ä¸ªå¼•è„šçš„ç®€è¦è¯´æ˜">
<ul>
<li>å¼•è„š
12ï¼ˆINTï¼‰ä½œä¸ºä¸­æ–­æ•°å­—è¾“å‡ºå¼•è„šï¼Œä¸»è¦ä½œç”¨æ˜¯é€šè¿‡è¾“å‡ºä¿¡å·å‘ç³»ç»Ÿå¤„ç†å™¨è§¦å‘ä¸­æ–­ï¼Œæç¤ºç‰¹å®šäº‹ä»¶çš„å‘ç”Ÿï¼Œä»è€Œå®ç°è®¾å¤‡ä¸å¤„ç†å™¨ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œå‡å°‘å¤„ç†å™¨çš„æ— æ•ˆ
pollingï¼ˆè½®è¯¢ï¼‰ï¼Œé™ä½ç³»ç»ŸåŠŸè€—ã€‚</li>
</ul>
<h3 id="spl06-001-æ•°å­—æ°”å‹ä¼ æ„Ÿå™¨">SPL06-001 æ•°å­—æ°”å‹ä¼ æ„Ÿå™¨</h3>
<p>SPL06-001ï¼Œæ•°å­—æ°”å‹ä¼ æ„Ÿå™¨ï¼Œå¯åŒæ—¶æµ‹é‡å‹åŠ›å’Œæ¸©åº¦</p>
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/SPL06-001.png" class="" title="SPL06-001å…¸å‹ç”¨æ³•">
<p>ä¼ æ„Ÿå™¨åœ°å€ä¸º 0x77ï¼ˆé»˜è®¤ï¼‰ï¼Œè‹¥ SDO å¼•è„šä¸‹æ‹‰è‡³åœ°ï¼Œåˆ™åœ°å€ä¸º 0x76
ã€‚æ­¤å¤„ä¸‹æ‹‰åˆ°åœ°ã€‚</p>
<h3 id="aht21b-æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨">AHT21B æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨</h3>
<p>ä¸€æ®µè¯æ€»ç»“ï¼šSPL06-001 æ˜¯æ­Œå°”è‚¡ä»½ç”Ÿäº§çš„ä¸€æ¬¾å°å‹åŒ–æ•°å­—æ°”å‹ä¼ æ„Ÿå™¨ï¼ˆç‰ˆæœ¬
7.0ï¼Œä¿å¯†çº§åˆ«ä¸ºæœºå¯†ï¼‰ï¼Œå¯åŒæ—¶æµ‹é‡å‹åŠ›å’Œæ¸©åº¦ï¼Œå…·æœ‰æ— é“…ã€æ— å¤ç´ ã€ç¬¦åˆ RoHS
æ ‡å‡†çš„ç‰¹ç‚¹ ğŸ”¶1-4ğŸ”¶ã€‚å…¶å‹åŠ›æµ‹é‡èŒƒå›´ä¸º 300~1100hPaï¼ˆå¯¹åº”æµ·æ‹” + 9000m è‡³ -
500mï¼‰ï¼Œæ¸©åº¦èŒƒå›´ä¸º - 40~+85â„ƒï¼Œå‹åŠ›ç›¸å¯¹ç²¾åº¦è¾¾ Â±0.06hPaï¼Œæ¸©åº¦ç²¾åº¦
Â±0.5â„ƒï¼Œæ”¯æŒ I2C å’Œ SPI æ¥å£ï¼Œå…·å¤‡ FIFO åŠŸèƒ½ï¼ˆå¯å­˜å‚¨ 32
æ¬¡æµ‹é‡ï¼‰ï¼Œæ“ä½œæ¨¡å¼åŒ…æ‹¬å¾…æœºã€å‘½ä»¤å’ŒèƒŒæ™¯æ¨¡å¼ï¼Œé€‚ç”¨äº GPS
å¯¼èˆªå¢å¼ºã€æ°”è±¡é¢„æŠ¥ç­‰åœºæ™¯ã€‚</p>
<p>ç”µè·¯ç®€å•ï¼Œä¸ç”¨å¤šçœ‹</p>
<h3 id="lsm303dlhc-æŒ‡å—é’ˆæ¨¡å—">LSM303DLHC æŒ‡å—é’ˆæ¨¡å—</h3>
<p>LSM303DLHC æ˜¯ä¸€æ¬¾è¶…ç´§å‡‘å‹é«˜æ€§èƒ½ eCompass æ¨¡å—ï¼Œé›†æˆ 3D åŠ é€Ÿåº¦è®¡å’Œ 3D
ç£åŠ›è®¡ï¼Œé‡‡ç”¨ LGA-14ï¼ˆ3x5x1mmï¼‰å°è£…ã€‚å…¶æ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬ï¼š3 ä¸ªç£åœºé€šé“å’Œ 3
ä¸ªåŠ é€Ÿåº¦é€šé“ï¼ŒåŠ é€Ÿåº¦æµ‹é‡èŒƒå›´ä¸º Â±2g/Â±4g/Â±8g/Â±16gï¼Œç£åœºæµ‹é‡èŒƒå›´ä¸º Â±1.3 è‡³
Â±8.1 é«˜æ–¯ï¼Œæ”¯æŒ I2C ä¸²è¡Œæ¥å£ï¼Œæ¨¡æ‹Ÿä¾›ç”µç”µå‹ 2.16V è‡³
3.6Vï¼Œå…·å¤‡ä½åŠŸè€—æ¨¡å¼ã€å¯ç¼–ç¨‹ä¸­æ–­ã€åµŒå…¥å¼æ¸©åº¦ä¼ æ„Ÿå™¨å’Œ FIFO ç­‰åŠŸèƒ½
1-10ğŸ”·1-11ğŸ”·1-12ğŸ”·1-14ğŸ”·1-15ğŸ”·ã€‚ä¸»è¦åº”ç”¨äºå€¾æ–œè¡¥å¿æŒ‡å—é’ˆã€åœ°å›¾æ—‹è½¬ã€è¿åŠ¨æ£€æµ‹ã€è®¡æ­¥å™¨ã€è™šæ‹Ÿç°å®è®¾å¤‡ç­‰åœºæ™¯è‡³
1-28ğŸ”·ï¼Œå·¥ä½œæ¸©åº¦èŒƒå›´ä¸º - 40Â°C è‡³ + 85Â°Cã€‚</p>
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/compass.png" class="" title="LSM303DLHCæŒ‡å—é’ˆæ¨¡å—å…¸å‹ç”¨æ³•">
<ul>
<li>INT1/INT2ï¼šä¸­æ–­è¾“å‡ºå¼•è„šï¼Œå¯é…ç½®ä¸ºåŠ é€Ÿåº¦è®¡ã€ç£åŠ›è®¡çš„äº‹ä»¶è§¦å‘ï¼ˆå¦‚è‡ªç”±è½ä½“ã€ç£åœºçªå˜ï¼‰ï¼Œè§¦å‘åå‘ä¸»æ§å‘ä¸­æ–­ä¿¡å·ï¼Œå®ç°
â€œäº‹ä»¶ - å“åº”â€ åŠŸèƒ½ï¼ˆå¦‚è®¾å¤‡è·Œè½ä¿æŠ¤ï¼‰ã€‚</li>
<li>DRDYï¼šæ•°æ®å°±ç»ªå¼•è„šï¼Œä¼ æ„Ÿå™¨å®Œæˆä¸€æ¬¡æ•°æ®é‡‡é›†ï¼ˆåŠ é€Ÿåº¦ /
ç£åœºï¼‰åï¼Œè¯¥å¼•è„šç”µå¹³å˜åŒ–ï¼Œé€šçŸ¥ä¸»æ§ â€œå¯è¯»å–æ–°æ•°æ®â€ï¼Œé¿å…æ— æ•ˆè½®è¯¢ã€‚</li>
</ul>
<h3 id="em7028-å¿ƒç‡æ£€æµ‹">EM7028 å¿ƒç‡æ£€æµ‹</h3>
<p>EM7028 æ˜¯ä¸€æ¬¾å…·æœ‰ I2C æ¥å£çš„ä½åŠŸè€—å¿ƒç‡ä¼ æ„Ÿå™¨ï¼Œå†…ç½® 2 ä¸ª 525nm ç»¿è‰²
LED å’Œ LED ç”µæµé©±åŠ¨å™¨ï¼Œæ”¯æŒè¿ç»­æ¨¡å¼ï¼ˆHRS1ï¼‰ å’Œè„‰å†²æ¨¡å¼ï¼ˆHRS2ï¼‰
ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼Œé€‚ç”¨äºæ™ºèƒ½æ‰‹è¡¨ç­‰å¿ƒç‡æ£€æµ‹åœºæ™¯ã€‚å…¶æ ¸å¿ƒç‰¹ç‚¹åŒ…æ‹¬ 16 ä½
ADCã€50Hz/60Hz é—ªçƒå™ªå£°æŠ‘åˆ¶ã€æ¸©åº¦è¡¥å¿ã€å¯ç¼–ç¨‹ LED ç”µæµï¼ˆæœ€é«˜
200mAï¼‰åŠä½å¹³å‡åŠŸè€—ï¼Œå·¥ä½œç”µå‹èŒƒå›´ä¸º 2.5V~3.6Vï¼Œå°è£…å°ºå¯¸ä¸º
4.0mmÃ—2.4mmÃ—1.35mmã€‚</p>
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/heartrate_pin.png" class="" title="EM7028å¼•è„šå®šä¹‰">
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/heart_rate.png" class="" title="å¿ƒè·³æ£€æµ‹ç”µè·¯">
<p><em>æ­¤å¤„é‡‡ç”¨çš„æ˜¯è¿ç»­æ£€æµ‹æ¨¡å¼</em></p>
<h3 id="è“ç‰™">è“ç‰™</h3>
<p>è“ç‰™æ¨¡å—ç”± BL1551B å•åˆ€åŒæ·ï¼ˆSPDTï¼‰æ¨¡æ‹Ÿå¼€å…³ï¼ŒKT6368Aï¼Œ24MHz æ™¶æŒ¯</p>
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/ble.png" class="" title="è“ç‰™ç”µè·¯">
<ul>
<li>BL1551B çš„ ENB ä¸º 1ï¼ŒA1 ä¸ B è¿æ¥ã€‚ ENB ä¸º 0ï¼ŒA2 ä¸ B è¿æ¥</li>
<li>KT6368A å¼•è„šå®šä¹‰å¦‚ä¸‹å›¾</li>
</ul>
<img src="/2025/08/05/%E6%99%BA%E8%83%BD%E6%89%8B%E8%A1%A8%E5%A4%8D%E5%88%BB%E7%AC%94%E8%AE%B0/KT6368A.png" class="" title="è“ç‰™ç”µè·¯">
<h3 id="stm32f411ceu6">STM32F411CEU6</h3>
<p>å…ˆ markï¼Œåé¢å­¦</p>
<h3 id="ä¾›ç”µéƒ¨åˆ†-1">ä¾›ç”µéƒ¨åˆ†</h3>
<p>ä¾›ç”µéƒ¨åˆ†ä½¿ç”¨äº† TPS63020, å‡é™å‹èŠ¯ç‰‡, è¾“å…¥ç«¯æ¥åˆ°ç”µæ± , ä½¿èƒ½ç«¯ TPS_EN
æ¥åˆ° MCU çš„ä¸€ä¸ª GPIO(POWER_EN), ç”¨äº MCU æ§åˆ¶ä½¿èƒ½, è½¯ä»¶æ§åˆ¶ä¾›ç”µ. åŒæ—¶
Bat ç”µæ± ç«¯æ¥åˆ°å¼€å…³, å³å¯ä»¥æŒ‰é”®æŒ‰ä¸‹è®©ä¾›ç”µèŠ¯ç‰‡ä½¿èƒ½. è¿™ä¸ªæŒ‰é”®ä¹Ÿå¤ç”¨ä¸º KEY2,
GPIO(WAKE)ä¸ºé«˜çš„æ—¶å€™ä»£è¡¨æŒ‰é”®æŒ‰ä¸‹.</p>
<p>ä¹Ÿå°±æ˜¯è¯´, å…³æœºåä½ å¯ä»¥æŒ‰é”® KEY2 ä¸Šç”µï¼Œä½¿èƒ½ TPS
ä¾›ç”µèŠ¯ç‰‡ï¼Œç„¶åè¿‡ä¸€æ®µæ—¶é—´åï¼ŒMCU çš„ POWER_EN å¼•è„šç½® 1ï¼Œä½ æ¾å¼€ KEY2
åèƒ½å¤Ÿä»ç„¶ä¿æŒ TPS èŠ¯ç‰‡ä½¿èƒ½ä¾›ç”µã€‚ <img
src="https://no-chicken.com/images/OV-Watch/3/%E4%BE%9B%E7%94%B5.jpg" /></p>
<h3 id="å……ç”µéƒ¨åˆ†-1">å……ç”µéƒ¨åˆ†</h3>
<p>å……ç”µéƒ¨åˆ†ä½¿ç”¨ TP4056M, ç”¨äºç»™æ ‡å‡† 3.7V é”‚ç”µæ± å……ç”µ, è¾“å…¥ä¸º 5V,
æ¥å£é€šè¿‡è¿‡å­”è¿æ¥åˆ°äº† Back çš„ä¸¤ä¸ªç„Šç›˜, å¯¹åº” 2.84mm ç£å¸çº¿çš„ä¸¤ä¸ªè§¦ç‚¹,
ä¸€ä¸ª+5V ä¸€ä¸ª GND. charge è¿åˆ° PA2ï¼Œç”¨äºè§¦å‘å……ç”µä¸­æ–­</p>
<p><img src="https://no-chicken.com/images/OV-Watch/3/Charge.jpg" /></p>
<h3 id="eeprom-å’Œçœ‹é—¨ç‹—">EEPROM å’Œçœ‹é—¨ç‹—</h3>
<p>åˆ†åˆ«ç”¨ BL24C02F-RRRC å’Œ TPS3823-33DBVR</p>
<h2 id="è½¯ä»¶æ¡†æ¶">è½¯ä»¶æ¡†æ¶</h2>
<p>è½¯ä»¶æ€»ä½“æ¶æ„å¦‚ä¸‹å›¾ <img
src="https://no-chicken.com/images/OV-Watch/0/software%20structure.jpg" /></p>
<h3 id="mdk-å·¥ç¨‹ç»“æ„">MDK å·¥ç¨‹ç»“æ„</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€Application/MDK-ARM               # ç”¨äºå­˜æ”¾.sæ–‡ä»¶</span><br><span class="line">â”œâ”€Application/User/Core             # ç”¨äºå­˜æ”¾CubeMXç”Ÿæˆçš„åˆå§‹åŒ–æ–‡ä»¶</span><br><span class="line">â”‚  â”‚  main.c</span><br><span class="line">â”‚  â”‚  gpio.c</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Application/User/System           # ç”¨äºå­˜æ”¾è‡ªå®šä¹‰çš„delay.c sys.hç­‰</span><br><span class="line">â”‚  â”‚  delay.c</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Application/User/Tasks            # ç”¨äºå­˜æ”¾ä»»åŠ¡çº¿ç¨‹çš„å‡½æ•°</span><br><span class="line">â”‚  â”‚  user_TaskInit.c</span><br><span class="line">â”‚  â”‚  user_HardwareInitTask.c</span><br><span class="line">â”‚  â”‚  user_RunModeTasks.c</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Application/User/MidFunc          # ç”¨äºå­˜æ”¾ç®¡ç†å‡½æ•°</span><br><span class="line">â”‚  â”‚  StrCalculate.c</span><br><span class="line">â”‚  â”‚  HWDataAccess.c</span><br><span class="line">â”‚  â”‚  PageManager.c</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Application/User/GUI_APP          # ç”¨äºå­˜æ”¾ç”¨æˆ·çš„ui app</span><br><span class="line">â”‚  â”‚  ui.c</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Application/User/GUI_FONT_IMG     # ç”¨äºå­˜æ”¾å­—ä½“å’Œå›¾ç‰‡</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Drivers/CMSIS</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Drivers/User/BSP                  # ç”¨äºå­˜æ”¾æ¿è½½è®¾å¤‡é©±åŠ¨</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Middleware/FreeRTOS               # FreeRTOSçš„åº•å±‚</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€Middleware/LVGL/GUI               # LVGLçš„åº•å±‚</span><br><span class="line">â”‚  â”‚  ...</span><br><span class="line">â”‚</span><br><span class="line">â””â”€Middleware/LVGL/GUI_Port          # ç”¨äºå­˜æ”¾LVGLé©±åŠ¨</span><br><span class="line">    â”œâ”€lv_port_disp.c</span><br><span class="line">    â”œâ”€lv_port_indev.c</span><br></pre></td></tr></table></figure>
<h3 id="cubemx-æ¡†æ¶">CubeMX æ¡†æ¶</h3>
<p>å·¥ç¨‹æ˜¯ç”¨ CubeMX ç”Ÿæˆçš„ MDK å·¥ç¨‹ï¼Œè¿™é‡Œé»˜è®¤ä½¿ç”¨çš„ AC5 ç¼–è¯‘ã€‚</p>
<p>æœ¬æ¬¡æ‰‹è¡¨é¡¹ç›®ä½¿ç”¨åˆ°çš„ç‰‡ä¸Šå¤–è®¾åŒ…æ‹¬ GPIO, IIC, SPI, USART, TIM, ADC,
DMA, å…·ä½“çš„å¯¹ PCB æ¿ä¸Šå™¨ä»¶çš„é©±åŠ¨ï¼Œä¾‹å¦‚ LCD, EEPROM ç­‰ï¼Œè¯¦è§ BSPã€‚</p>
<p>ç®€è¿°ä¸€ä¸‹å„ä¸ªç‰‡ä¸Šå¤–è®¾çš„ç”¨é€”ï¼š</p>
<ol type="1">
<li><p>DMA è¿™é‡Œä¸»è¦æ˜¯é…åˆ SPIï¼ŒSPI é€šä¿¡ä¸é€šè¿‡ CPU è€Œæ˜¯é€šè¿‡ DMA
ç›´æ¥å‘é€ï¼Œå¦‚æœä½¿ç”¨å¤šçº¿ç¨‹ï¼Œé‚£ä¹ˆè§†è§‰ä¸Šæ¥è®²ï¼Œåˆ·å±åº”è¯¥å°±ä¼šå¿«ä¸€äº›ï¼Œå› ä¸º CPU
å¯ä»¥å»æ‰§è¡Œå…¶å®ƒä»»åŠ¡ï¼›</p></li>
<li><p>IIC ä¸»è¦ç”¨æ¥è·Ÿ Back
æ¿å„ä¸ªä¼ æ„Ÿå™¨è¿›è¡Œé€šä¿¡ï¼Œä¼ æ„Ÿå™¨éƒ½æŒ‚åœ¨ä¸€ä¸ªæ€»çº¿ä¸Šçš„ï¼›</p></li>
<li><p>TIM ä¸»è¦æ˜¯æä¾›æ—¶åŸºï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯ç»™ LCD è°ƒèŠ‚èƒŒå…‰ï¼›</p></li>
<li><p>ADC
åªæ¥äº†ä¸€ä¸ªç”µæ± çš„åˆ†å‹ï¼Œè¿›è¡Œç”µæ± ç”µå‹é‡‡æ ·ï¼Œé¢„ä¼°å‰©ä½™ç”µé‡ï¼›</p></li>
<li><p>USART æ¥äº†è“ç‰™ï¼Œæ–¹ä¾¿è¿›è¡Œ IAP å’Œä¸æ‰‹æœºå’Œç”µè„‘çš„åŠ©æ‰‹é€šä¿¡ã€‚</p></li>
</ol>
<h3 id="æ¿è½½é©±åŠ¨-bsp">æ¿è½½é©±åŠ¨ BSP</h3>
<ol type="1">
<li><p>WDOG é‡‡ç”¨å¤–ç½®çš„åŸå› æ˜¯ï¼Œæƒ³è¦åšç¡çœ ä½åŠŸè€—ï¼Œé‚£ä¹ˆä½¿ç”¨ MCU
å†…éƒ¨çš„çœ‹é—¨ç‹—å…³é—­ä¸äº†ï¼Œåªèƒ½ä¸€ç›´å”¤é†’å–‚ç‹—ï¼Œå¦åˆ™å°±è¦é‡å¯ï¼Œé‚£ä¹ˆè¿™æ ·å°±å¤±å»äº†ç¡çœ çš„æ„ä¹‰äº†ï¼›</p></li>
<li><p>IIC ä½¿ç”¨çš„è½¯ä»¶æ¨¡æ‹Ÿçš„æ–¹å¼è¿›è¡Œé©±åŠ¨</p></li>
<li><p>key æŒ‰é”®çš„é©±åŠ¨ï¼ŒGPIO è®¾ç½®æœ‰æ·»åŠ ä¸­æ–­ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†æŒ‰é”®å”¤é†’è¿›å…¥ STOP
æ¨¡å¼çš„ MCUï¼›</p></li>
<li><p>EM7028
å¿ƒç‡ï¼Œé©±åŠ¨ä¸­åªå†™äº†å¯¹å¯„å­˜å™¨çš„è¯»å–ï¼Œå…·ä½“çš„å¿ƒç‡ç®—æ³•å’Œè¡€æ°§ç®—æ³•æ²¡æœ‰æ”¾åœ¨ BSP
ä¸­ï¼›</p></li>
<li><p>DataSave æ•°æ®ä¿å­˜ï¼Œä¸ºäº†æ–¹ä¾¿ä¿å­˜æ‰‹è¡¨è®¾ç½®ç­‰æ•°æ®ï¼Œè‡ªå®šä¹‰äº† EEPROM
ä¸­çš„å­˜å‚¨å¸§ï¼Œè¯¦è§ä»£ç ï¼›</p></li>
<li><p>IMUï¼Œdmp åº“ä¸­çš„ init å‡½æ•°æ˜¯æ”¹è¿‡çš„ï¼Œè¿˜æœ‰
MP6050.cï¼Œæœ‰æ¯”è¾ƒå¤šä½åŠŸè€—ç›¸å…³çš„ï¼Œå»ºè®®ç›´æ¥æ‹¿å»ç”¨ï¼Œä¸éœ€è¦å†æ”¹äº†ã€‚å…³äº
MPU6050
è®°æ­¥çš„é—®é¢˜ï¼Œéš¾ç‚¹ä¸»è¦åœ¨å®ç°ä½åŠŸè€—è®°æ­¥ï¼Œå®ƒçš„å†…éƒ¨æ˜¯æœ‰ä¸€ä¸ªå¯„å­˜å™¨å­˜å‚¨æ­¥æ•°çš„ï¼Œåº”è¯¥
MPU6050
å†…éƒ¨æ˜¯æœ‰è®°æ­¥ç®—æ³•çš„ï¼Œä¸éœ€è¦ç”¨æˆ·åœ¨å¤–éƒ¨å†è‡ªå·±è®¾è®¡è®°æ­¥ç®—æ³•äº†ã€‚</p></li>
</ol>
<h3 id="ç¡¬ä»¶è®¿é—®æœºåˆ¶-hwdataaccess">ç¡¬ä»¶è®¿é—®æœºåˆ¶-HWDataAccess</h3>
<p>åœ¨ HWDataAccess.c ä¸­ï¼Œä½¿ç”¨ç»“æ„ä½“è¿›è¡Œå„ä¸ªç¡¬ä»¶ç®¡ç†ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚å„ä¸ª
typedef å®šä¹‰åœ¨ HWDataAccess.h ä¸­å¯ä»¥çœ‹åˆ°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/***************************</span><br><span class="line"> *  External Variables</span><br><span class="line"> ***************************/</span><br><span class="line">HW_InterfaceTypeDef HWInterface = &#123;</span><br><span class="line">    .RealTimeClock = &#123;</span><br><span class="line">        .GetTimeDate = HW_RTC_Get_TimeDate,</span><br><span class="line">        .SetDate = HW_RTC_Set_Date,</span><br><span class="line">        .SetTime = HW_RTC_Set_Time,</span><br><span class="line">        .CalculateWeekday = HW_weekday_calculate</span><br><span class="line">    &#125;,</span><br><span class="line">    .BLE = &#123;</span><br><span class="line">        .Enable = HW_BLE_Enable,</span><br><span class="line">        .Disable = HW_BLE_Disable</span><br><span class="line">    &#125;,</span><br><span class="line">    .Power = &#123;</span><br><span class="line">		.power_remain = 0,</span><br><span class="line">		.Init = HW_Power_Init,</span><br><span class="line">        .Shutdown = HW_Power_Shutdown,</span><br><span class="line">		.BatCalculate = HW_Power_BatCalculate</span><br><span class="line">    &#125;,</span><br><span class="line">    .LCD = &#123;</span><br><span class="line">        .SetLight = HW_LCD_Set_Light</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">	.IMU = &#123;</span><br><span class="line">		.ConnectionError = 1,</span><br><span class="line">		.Steps = 0,</span><br><span class="line">		.wrist_is_enabled = 0,</span><br><span class="line">		.wrist_state = WRIST_UP,</span><br><span class="line">		.Init = HW_MPU_Init,</span><br><span class="line">        .WristEnable = HW_MPU_Wrist_Enable,</span><br><span class="line">        .WristDisable = HW_MPU_Wrist_Disable,</span><br><span class="line">        .GetSteps = HW_MPU_Get_Steps,</span><br><span class="line">		.SetSteps = HW_MPU_Set_Steps</span><br><span class="line">    &#125;,</span><br><span class="line">	.AHT21 = &#123;</span><br><span class="line">		.ConnectionError = 1,</span><br><span class="line">		.humidity = 67,</span><br><span class="line">		.temperature = 26,</span><br><span class="line">		.Init = HW_AHT21_Init,</span><br><span class="line">		.GetHumiTemp = HW_AHT21_Get_Humi_Temp</span><br><span class="line">	&#125;,</span><br><span class="line">	.Barometer = &#123;</span><br><span class="line">		.ConnectionError = 1,</span><br><span class="line">		.altitude = 19,</span><br><span class="line">		.Init = HW_Barometer_Init,</span><br><span class="line">	&#125;,</span><br><span class="line">	.Ecompass = &#123;</span><br><span class="line">		.ConnectionError = 1,</span><br><span class="line">		.direction = 45,</span><br><span class="line">		.Init = HW_Ecompass_Init,</span><br><span class="line">		.Sleep = HW_Ecompass_Sleep</span><br><span class="line">	&#125;,</span><br><span class="line">	.HR_meter = &#123;</span><br><span class="line">		.ConnectionError = 1,</span><br><span class="line">		.HrRate = 0,</span><br><span class="line">		.SPO2 = 99,</span><br><span class="line">		.Init = HW_HRmeter_Init,</span><br><span class="line">		.Sleep = HW_HRmeter_Sleep</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä½•åœ¨ UI å±‚ä½¿ç”¨ HWDataAccess å‘¢ï¼Œä¾‹å¦‚åœ¨ HomePage ä¸­çš„è°ƒèŠ‚ LCD
äº®åº¦çš„å›è°ƒå‡½æ•°ä¸­ï¼Œè¿™ä¹ˆä½¿ç”¨ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨
HWInterface.LCD.SetLight(ui_LightSliderValue);å³å¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void ui_event_LightSlider(lv_event_t * e)</span><br><span class="line">&#123;</span><br><span class="line">    lv_event_code_t event_code = lv_event_get_code(e);</span><br><span class="line">    lv_obj_t * target = lv_event_get_target(e);</span><br><span class="line">    if(event_code == LV_EVENT_VALUE_CHANGED)</span><br><span class="line">    &#123;</span><br><span class="line">        ui_LightSliderValue = lv_slider_get_value(ui_LightSlider);</span><br><span class="line">        HWInterface.LCD.SetLight(ui_LightSliderValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆä»–æ˜¯å¦‚ä½•åœ¨æœ‰ç¡¬ä»¶çš„ MDK å·¥ç¨‹ä¸­ä¹Ÿèƒ½ç”¨ï¼ŒLVGL
æ— ç¡¬ä»¶çš„ä»¿çœŸä¹Ÿèƒ½ç”¨ï¼Œæˆ‘ä»¬çœ‹åˆ° HWInterface.LCD.SetLight
å¯¹åº”çš„å‡½æ•°æ˜¯ä»€ä¹ˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HW_InterfaceTypeDef HWInterface = &#123;</span><br><span class="line">    // çœç•¥å‰é¢</span><br><span class="line">    .LCD = &#123;</span><br><span class="line">            .SetLight = HW_LCD_Set_Light</span><br><span class="line">        &#125;,</span><br><span class="line">    // çœç•¥åé¢</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆçœ‹åˆ°<code>HWInterface.LCD.SetLight</code>å®šä¹‰çš„æ˜¯å‡½æ•°<code>HW_LCD_Set_Light</code>ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„å†…å®¹å¦‚ä¸‹ï¼Œå³å½“<code>HW_USE_LCD</code>ä½¿èƒ½æ—¶ï¼Œè¿è¡Œè¿™ä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿæ­£å¸¸è°ƒå…‰ï¼Œå½“
LVGL ä»¿çœŸä¸­ä¸ä½¿èƒ½ç¡¬ä»¶<code>HW_USE_HARDWARE</code>æ—¶,
<code>HW_USE_LCD</code>ä¹Ÿä¸ä½¿èƒ½ï¼Œåˆ™æ­¤å‡½æ•°æ‰§è¡Œç©ºï¼Œå·¥ç¨‹ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void HW_LCD_Set_Light(uint8_t dc)</span><br><span class="line">&#123;</span><br><span class="line">	#if HW_USE_LCD</span><br><span class="line">		LCD_Set_Light(dc);</span><br><span class="line">	#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lvgl-é¡µé¢ç®¡ç†-pagemanager">LVGL é¡µé¢ç®¡ç†-PageManager</h3>
<p><strong>PageManager æ¡†æ¶</strong> OV-Watch æ‰‹è¡¨é¡¹ç›®çš„ LVGL
é¡µé¢æœ‰å¾ˆå¤šï¼Œåœ¨ GUI_App æ–‡ä»¶å¤¹ä¸­ï¼ŒScreen æ–‡ä»¶å¤¹ä¸­å­˜æ”¾ç€æ‰€æœ‰çš„ pageã€‚ç”±äº
screen å¾ˆå¤šï¼Œæ‰€ä»¥æœ‰å¿…è¦è¿›è¡Œé¡µé¢ç®¡ç†ã€‚è¿™é‡Œå¼€ä¸€ä¸ªæ ˆè¿›è¡Œé¡µé¢ç®¡ç†ã€‚</p>
<p>é¦–å…ˆçœ‹åˆ°<code>PageManager.h</code>,
<code>Page_t</code>ç»“æ„ä½“æ˜¯ç”¨äºæè¿°ä¸€ä¸ª LVGL
é¡µé¢çš„ï¼Œé‡Œé¢çš„å¯¹è±¡æœ‰åˆå§‹åŒ–å‡½æ•°<code>init</code>ï¼Œååˆå§‹åŒ–å‡½æ•°<code>deinit</code>ä»¥åŠä¸€ä¸ªç”¨äºå­˜æ”¾
lvgl å¯¹è±¡çš„åœ°å€çš„<code>lv_obj_t **page_obj</code>ã€‚</p>
<p><code>PageStack_t</code>ç»“æ„ä½“æè¿°ä¸€ä¸ªç•Œé¢æ ˆï¼Œç”¨äºå­˜æ”¾<code>Page_t</code>é¡µé¢ç»“æ„ä½“ï¼Œ<code>top</code>è¡¨ç¤ºæ ˆé¡¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// é¡µé¢æ ˆæ·±åº¦</span><br><span class="line">#define MAX_DEPTH 6</span><br><span class="line"></span><br><span class="line">// é¡µé¢ç»“æ„ä½“</span><br><span class="line">typedef struct &#123;</span><br><span class="line">    void (*init)(void);</span><br><span class="line">    void (*deinit)(void);</span><br><span class="line">    lv_obj_t **page_obj;</span><br><span class="line">&#125; Page_t;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// é¡µé¢å †æ ˆç»“æ„ä½“</span><br><span class="line">typedef struct &#123;</span><br><span class="line">    Page_t* pages[MAX_DEPTH];</span><br><span class="line">    uint8_t top;</span><br><span class="line">&#125; PageStack_t;</span><br><span class="line"></span><br><span class="line">extern PageStack_t PageStack;</span><br></pre></td></tr></table></figure>
<p>å†çœ‹åˆ°<code>PageManager.c</code>ï¼Œæ ˆçš„åˆå§‹åŒ–è¿˜æœ‰ push å’Œ pop
æ“ä½œå°±ä¸å†èµ˜è¿°äº†ï¼Œåœ¨ pop å‡½æ•°ä¸­ï¼Œé™¤äº†å°† top å‡ 1ï¼Œè¿˜è°ƒç”¨äº†é¡µé¢ deinit
å‡½æ•°ï¼Œè´Ÿè´£ååˆå§‹åŒ–å½“å‰é¡µé¢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack-&gt;pages[--stack-&gt;top]-&gt;deinit();</span><br></pre></td></tr></table></figure>
<p><code>Page_Back()</code>, <code>Page_Back_Bottom()</code>,
<code>Page_Load()</code>å°±æ˜¯ä¸»è¦åœ¨ä»£ç ä¸­è°ƒç”¨çš„å‡½æ•°äº†ï¼Œåˆ†åˆ«çš„ä½œç”¨æ˜¯ Back
åˆ°ä¸Šä¸€ä¸ªç•Œé¢ï¼ŒBack åˆ°æœ€åº•éƒ¨çš„ Home ç•Œé¢ï¼Œä»¥åŠ load æ–°çš„ç•Œé¢ã€‚</p>
<p><strong>å¦‚ä½•åœ¨ ui app ä¸­ä½¿ç”¨ PageManager</strong>
è¿™é‡Œä»¥ä»£ç æ¯”è¾ƒå°‘çš„<code>ui_ChargPage.c</code>ä¸ºä¾‹ã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ª
Page
ç»“æ„ä½“å­˜å‚¨å½“å‰çš„é¡µé¢ï¼Œå¡«å……å¥½åˆå§‹åŒ–<code>init</code>ï¼Œååˆå§‹åŒ–å‡½æ•°<code>deinit</code>ä»¥åŠ
LVGL
é¡µé¢å¯¹è±¡<code>&amp;ui_ChargPage</code>ï¼Œç„¶åæˆ‘çš„<code>deinit</code>æ˜¯ç”¨äºåˆ é™¤å®šæ—¶å™¨<code>timer</code>çš„ï¼Œè¿™é‡Œçš„<code>timer</code>ä¸»è¦ç”¨äºåˆ·å½“å‰é¡µé¢çš„æ•°æ®ï¼Œæ‰€ä»¥ä¸åœ¨å½“å‰é¡µé¢æ—¶éœ€è¦åˆ é™¤æ‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// çœç•¥å‰é¢...</span><br><span class="line"></span><br><span class="line">///////////////////// Page Manager //////////////////</span><br><span class="line">Page_t Page_Charg = &#123;ui_ChargPage_screen_init, ui_ChargPage_screen_deinit, &amp;ui_ChargPage&#125;;</span><br><span class="line"></span><br><span class="line">/////////////////////// Timer //////////////////////</span><br><span class="line">// need to be destroyed when the page is destroyed</span><br><span class="line">static void ChargPage_timer_cb(lv_timer_t * timer)</span><br><span class="line">&#123;</span><br><span class="line">    if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_ChargPage)</span><br><span class="line">    &#123;</span><br><span class="line">        // åˆ·æ–°æ•°æ®ç­‰æ“ä½œ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">///////////////////// SCREEN init ////////////////////</span><br><span class="line">void ui_ChargPage_screen_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    // çœç•¥ä¸­é—´...</span><br><span class="line">    // private timer</span><br><span class="line">    ui_ChargPageTimer = lv_timer_create(ChargPage_timer_cb, 2000,  NULL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/////////////////// SCREEN deinit ////////////////////</span><br><span class="line">void ui_ChargPage_screen_deinit(void)</span><br><span class="line">&#123;</span><br><span class="line">  lv_timer_del(ui_ChargPageTimer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// çœç•¥åé¢...</span><br></pre></td></tr></table></figure>
<h3 id="å¤šçº¿ç¨‹ä»»åŠ¡">å¤šçº¿ç¨‹ä»»åŠ¡</h3>
<p>æ­¤é¡¹ç›®éƒ½ç”¨çš„ CMSIS_OS_V2 çš„ APIã€‚Tasks æ–‡ä»¶ä»¥åŠå…¶ä½œç”¨å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€Application/User/Tasks            # ç”¨äºå­˜æ”¾ä»»åŠ¡çº¿ç¨‹çš„å‡½æ•°</span><br><span class="line">â”‚  â”œâ”€user_TaskInit.c                # åˆå§‹åŒ–ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_HardwareInitTask.c        # ç¡¬ä»¶åˆå§‹åŒ–ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_RunModeTasks.c            # è¿è¡Œæ¨¡å¼ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_KeyTask.c                 # æŒ‰é”®ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_DataSaveTask.c            # æ•°æ®ä¿å­˜ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_MessageSendTask.c         # æ¶ˆæ¯å‘é€ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_ChargeCheckTask.c         # å……ç”µæ£€æŸ¥ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_SensUpdateTask.c          # ä¼ æ„Ÿå™¨æ›´æ–°ä»»åŠ¡</span><br><span class="line">â”‚  â”œâ”€user_ScrRenewTask.c            # å±å¹•åˆ·æ–°ä»»åŠ¡</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><p>ä»»åŠ¡åˆå§‹åŒ–<code>TaskInit.c</code>ï¼Œæ³¨å†Œå„ä¸ªä»»åŠ¡ï¼Œåˆ†é…ç©ºé—´ï¼Œæ³¨å†Œä¸€äº›ä¿¡å·é‡ï¼Œä»»åŠ¡çš„æ±‡æ€»å¯ä»¥çœ‹è¿™ä¸ªæ–‡ä»¶ã€‚åŒæ—¶ä¹Ÿåˆ›å»ºäº†ä¸€ä¸ªè½¯ä»¶å®šæ—¶å™¨ï¼Œç”¨äºè®°å½•ç©ºé—²æ—¶é—´ï¼Œå³ç”¨æˆ·æ²¡æœ‰æ“ä½œè¿‡é•¿å°±ä¼šå‘å‡º<code>idle</code>ä¿¡å·ï¼Œ<code>idle</code>è¿‡é•¿ï¼Œå°±ä¼šå‘å‡º<code>STOP</code>ä¿¡å·ï¼Œè¿›å…¥ç¡çœ ã€‚LVGL
çš„æ—¶é’Ÿæä¾›ä¹Ÿæ”¾åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸º<code>LvHandlerTask</code>ã€‚çœ‹é—¨ç‹—çš„å–‚ç‹—
Task ä¹Ÿæ”¾åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚</p></li>
<li><p>ç¡¬ä»¶åˆå§‹åŒ–<code>user_HardwareInitTask.c</code>ï¼Œå…¶å®è¿™é‡Œåº”è¯¥å«
BootTaskï¼Œä¸ä»…ä»…æœ‰ç¡¬ä»¶çš„åˆå§‹åŒ–ï¼Œæœ€åè¿˜æœ‰ LVGL
çš„åˆå§‹åŒ–ã€‚è¿™ä¸ªä»»åŠ¡è¿è¡Œå®Œåï¼Œä¼šæŠŠæœ¬ä»»åŠ¡åˆ é™¤ï¼Œå³è°ƒç”¨<code>vTaskDelete(NULL)</code>ï¼›</p></li>
<li><p>æŒ‰é”®ä»»åŠ¡<code>keytask</code>ï¼ŒæŒ‰é”®å‘ç”Ÿå³å‘å‡ºä¿¡å·é‡ï¼Œè°ƒ<code>osMessageQueuePut(Key_MessageQueue, &amp;keystr, 0, 1);</code>å’Œ<code>osMessageQueuePut(IdleBreak_MessageQueue, &amp;IdleBreakstr, 0, 1);</code>ï¼Œä¸€ä¸ªæ˜¯æŒ‰é”®ä¿¡å·é‡ï¼Œä¸€ä¸ªæ˜¯ç©ºé—²æ‰“æ–­ä¿¡å·é‡ï¼›</p></li>
<li><p>å±å¹•åˆ‡æ¢ä»»åŠ¡<code>user_ScrRenewTask.c</code>ï¼Œæ¥å—æŒ‰é”®ä¿¡å·é‡ï¼Œç„¶åè°ƒç”¨<code>PageManager</code>ä¸­çš„å‡½æ•°ï¼›</p></li>
<li><p>è¿è¡Œæ¨¡å¼åˆ‡æ¢ä»»åŠ¡<code>user_RunModeTasks.c</code> ï¼Œä¸»è¦ç”¨äºè¿›å…¥
STOP æ¨¡å¼å’Œé€€å‡º STOP
æ¨¡å¼ï¼Œæ¥æ”¶åˆ°<code>Idle</code>è¶…æ—¶å‘å‡ºçš„<code>Stop_MessageQueue</code>ä¿¡å·é‡å°±è¿›å…¥
STOP æ¨¡å¼ã€‚è¿™é‡Œè·Ÿç¡¬ä»¶å’Œ UI çš„ç¡çœ æ—¶é—´è®¾ç½®å¼ºç›¸å…³ï¼Œæ¯”è¾ƒè€¦åˆ.</p></li>
<li><p>å…¶å®ƒè¯¦è§ä»£ç ã€‚</p></li>
</ol>
<h1 id="ui-ä¸é¡µé¢ç®¡ç†-lvgl-pagemanager">UI ä¸é¡µé¢ç®¡ç† (LVGL &amp;
PageManager)</h1>
<h1 id="å¤šçº¿ç¨‹ä»»åŠ¡-freertos-tasks">å¤šçº¿ç¨‹ä»»åŠ¡ (FreeRTOS Tasks)</h1>
<h2 id="user_taskslnit">user_Taskslnit</h2>
<p>è¿™ä¸ªæ–‡ä»¶æ˜¯æ•´ä¸ª FreeRTOS ç³»ç»Ÿçš„â€œå¿ƒè„â€ï¼Œå®ƒè´Ÿè´£ï¼š</p>
<ol type="1">
<li><p>å®šä¹‰æ‰€æœ‰ä»»åŠ¡çš„å±æ€§ï¼ˆåç§°ã€å †æ ˆå¤§å°ã€ä¼˜å…ˆçº§ï¼‰ã€‚</p></li>
<li><p>åˆ›å»ºæ‰€æœ‰ä»»åŠ¡çš„å¥æŸ„ï¼ˆHandleï¼‰ã€‚</p></li>
<li><p>åˆ›å»ºä»»åŠ¡é—´é€šä¿¡ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ã€‚</p></li>
<li><p>åˆ›å»ºä¸€ä¸ªå‘¨æœŸæ€§è½¯ä»¶å®šæ—¶å™¨ï¼ˆTimerï¼‰ã€‚</p></li>
<li><p>æä¾›ä¸€ä¸ªæ€»çš„åˆå§‹åŒ–å‡½æ•° User_Tasks_Init()ï¼Œç”¨äºåˆ›å»ºä¸Šè¿°æ‰€æœ‰ RTOS
å¯¹è±¡ã€‚</p></li>
<li><p>æä¾›ä¸€äº›ç‰¹æ®Šç”¨é€”çš„å‡½æ•°ï¼Œå¦‚ LvHandlerTaskï¼ˆLVGL
å›¾å½¢åº“å¤„ç†å™¨ï¼‰ã€WDOGFeedTaskï¼ˆçœ‹é—¨ç‹—å–‚ç‹—ä»»åŠ¡ï¼‰å’Œ
TaskTickHookï¼ˆç³»ç»ŸèŠ‚æ‹é’©å­å‡½æ•°ï¼‰ã€‚</p></li>
</ol>
<h3 id="ä»»åŠ¡å¥æŸ„å®šä¹‰">ä»»åŠ¡å¥æŸ„å®šä¹‰</h3>
<ul>
<li>HardwaresInitTaskï¼Œä¼˜å…ˆçº§ High+3</li>
<li>WDOGFeedTaskï¼Œä¼˜å…ˆçº§ High+2</li>
<li>StopEnterTaskï¼Œä¼˜å…ˆçº§ High+1</li>
<li>IdleEnterTaskï¼Œä¼˜å…ˆçº§ High</li>
<li>KeyTaskï¼Œä¼˜å…ˆçº§ Normal</li>
<li>MPUCheckTaskï¼ŒLow+2</li>
<li>DataSaveTaskï¼Œä¼˜å…ˆçº§ Low+2</li>
<li>ScrRenewTaskï¼Œä¼˜å…ˆçº§ Low+1</li>
<li>HRDataTaskï¼Œä¼˜å…ˆçº§ Low+1</li>
<li>ChargPageEnterTaskï¼Œä¼˜å…ˆçº§ Low+1</li>
<li>MessageSendTaskï¼Œä¼˜å…ˆçº§ Low+1</li>
<li>LVGLHandlerTaskï¼Œä¼˜å…ˆçº§ Low</li>
</ul>
<p>é«˜ä¼˜å…ˆçº§: HardwareInitTask, WDOGFeedTask, StopEnterTask
ç­‰ï¼Œè¿™äº›æ˜¯ä¿è¯ç³»ç»Ÿå¯åŠ¨ã€ä¸æ­»æœºå’Œæ­£ç¡®è¿›å…¥ä½åŠŸè€—çš„å…³é”®ä»»åŠ¡ï¼Œå¿…é¡»ä¼˜å…ˆæ‰§è¡Œã€‚</p>
<p>ä¸­ç­‰ä¼˜å…ˆçº§: KeyTask ç­‰ï¼Œéœ€è¦è¾ƒå¿«çš„å“åº”é€Ÿåº¦ã€‚</p>
<p>ä½ä¼˜å…ˆçº§: LvHandlerTask, SensorDataTask ç­‰ï¼Œè¿™äº›æ˜¯å¸¸è§„çš„æ•°æ®å¤„ç†å’Œ UI
åˆ·æ–°ä»»åŠ¡ï¼Œå¯ä»¥åœ¨ CPU ç©ºé—²æ—¶æ‰§è¡Œã€‚</p>
<h3 id="æ¶ˆæ¯é˜Ÿåˆ—å®šä¹‰">æ¶ˆæ¯é˜Ÿåˆ—å®šä¹‰</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* Message queues ------------------------------------------------------------*/</span><br><span class="line">osMessageQueueId_t Key_MessageQueue;</span><br><span class="line">osMessageQueueId_t Idle_MessageQueue;</span><br><span class="line">osMessageQueueId_t Stop_MessageQueue;</span><br><span class="line">osMessageQueueId_t IdleBreak_MessageQueue;</span><br><span class="line">osMessageQueueId_t HomeUpdata_MessageQueue;</span><br><span class="line">osMessageQueueId_t DataSave_MessageQueue;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>Key_MessageQueue</code>:
ç”¨äºä»æŒ‰é”®ä»»åŠ¡å‘é€æŒ‰é”®å€¼ã€‚</p></li>
<li><p><code>Idle_MessageQueue</code>:
ç”¨äºé€šçŸ¥ç³»ç»Ÿè¿›å…¥â€œç©ºé—²â€çŠ¶æ€ï¼ˆæ¯”å¦‚å±å¹•å˜æš—ï¼‰ã€‚</p></li>
<li><p><code>Stop_MessageQueue</code>:
ç”¨äºé€šçŸ¥ç³»ç»Ÿè¿›å…¥â€œåœæ­¢â€ï¼ˆSTOPï¼‰ä½åŠŸè€—æ¨¡å¼ã€‚</p></li>
<li><p><code>IdleBreak_MessageQueue</code>:
ç”¨äºæ‰“æ–­â€œç©ºé—²â€æˆ–â€œåœæ­¢â€çŠ¶æ€ï¼Œè®©ç³»ç»Ÿæ¢å¤æ­£å¸¸ã€‚</p></li>
<li><p><code>HomeUpdata_MessageQueue</code>:`
ç”¨äºé€šçŸ¥ä¸»ç•Œé¢æ›´æ–°æ˜¾ç¤ºæ•°æ®ã€‚</p></li>
<li><p><code>DataSave_MessageQueue</code>:
ç”¨äºè§¦å‘æ•°æ®ä¿å­˜ä»»åŠ¡ã€‚</p></li>
</ul>
<h3 id="user_tasks_init---æ€»åˆå§‹åŒ–å‡½æ•°"><code>User_Tasks_Init()</code> -
æ€»åˆå§‹åŒ–å‡½æ•°</h3>
<ul>
<li><p>è¿™ä¸ªå‡½æ•°åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼ˆé€šå¸¸åœ¨ main()å‡½æ•°ä¸­ï¼‰è¢«è°ƒç”¨ï¼Œå®Œæˆæ‰€æœ‰ RTOS
å¯¹è±¡çš„åˆ›å»ºã€‚</p></li>
<li><p>åˆ›å»ºå¹¶å¯åŠ¨å®šæ—¶å™¨:</p>
<p><code>osTimerNew(IdleTimerCallback, osTimerPeriodic, NULL, NULL)</code>:
åˆ›å»ºä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ã€‚</p>
<p><code>IdleTimerCallback</code>: å®šæ—¶å™¨åˆ°æœŸæ—¶è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚</p>
<p><code>osTimerPeriodic</code>: å®šæ—¶å™¨æ˜¯å‘¨æœŸæ€§çš„ã€‚</p>
<p><code>osTimerStart(IdleTimerHandle, 100)</code>:
å¯åŠ¨è¿™ä¸ªå®šæ—¶å™¨ï¼Œå‘¨æœŸä¸º 100 æ¯«ç§’ã€‚</p></li>
<li><p>åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—:</p>
<p><code>osMessageQueueNew(1, 1, NULL)</code>:
åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<p>ç¬¬ä¸€ä¸ª<code>1</code>: é˜Ÿåˆ—èƒ½å®¹çº³çš„æœ€å¤§æ¶ˆæ¯æ•°é‡ã€‚</p>
<p>ç¬¬äºŒä¸ª<code>1</code>: æ¯ä¸ªæ¶ˆæ¯çš„å¤§å°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ã€‚</p></li>
<li><p>åˆ›å»ºä»»åŠ¡ï¼ˆçº¿ç¨‹ï¼‰:</p>
<p><code>osThreadNew(HardwareInitTask, NULL, &amp;HardwareInitTask_attributes)</code>:
åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ã€‚</p>
<p><code>HardwareInitTask</code>: ä»»åŠ¡çš„æ‰§è¡Œå‡½æ•°ï¼ˆä»»åŠ¡çš„ C
å‡½æ•°åï¼‰ã€‚</p>
<p><code>NULL</code>: ä¼ é€’ç»™ä»»åŠ¡å‡½æ•°çš„å‚æ•°ï¼ˆè¿™é‡Œæ²¡æœ‰ï¼‰ã€‚</p>
<p><code>&amp;HardwareInitTask_attributes</code>:
ä¹‹å‰å®šä¹‰çš„ä»»åŠ¡å±æ€§ç»“æ„ä½“ã€‚</p></li>
<li><p>å‘é€åˆå§‹æ¶ˆæ¯:</p>
<p><code>osMessageQueuePut(HomeUpdata_MessageQueue, &amp;HomeUpdataStr, 0, 1)</code>:
åœ¨æ‰€æœ‰ä»»åŠ¡åˆ›å»ºåï¼Œç«‹å³å‘<code>HomeUpdata_MessageQueue</code>å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œç›®çš„æ˜¯è®©æ‰‹è¡¨ä¸€å¼€æœºå°±ä¸»åŠ¨æ›´æ–°ä¸€æ¬¡ä¸»ç•Œé¢çš„æ•°æ®ã€‚</p></li>
</ul>
<h3 id="tasktickhook---ç³»ç»ŸèŠ‚æ‹é’©å­å‡½æ•°"><code>TaskTickHook()</code> -
ç³»ç»ŸèŠ‚æ‹é’©å­å‡½æ•°</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void TaskTickHook(void)</span><br><span class="line">&#123;</span><br><span class="line">	//to increase the LVGL tick</span><br><span class="line">	lv_tick_inc(1);</span><br><span class="line">	//to increase the timerpage&#x27;s timer...</span><br><span class="line">	if(ui_TimerPageFlag)</span><br><span class="line">	&#123;</span><br><span class="line">        // ... (ç§’è¡¨é¡µé¢çš„è®¡æ—¶é€»è¾‘) ...</span><br><span class="line">	&#125;</span><br><span class="line">	user_HR_timecount+=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Hookï¼ˆé’©å­ï¼‰å‡½æ•°æ˜¯ RTOS
æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·åœ¨å†…æ ¸çš„ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œè‡ªå·±çš„ä»£ç ã€‚</p></li>
<li><p><code>TaskTickHook</code>ä¼šåœ¨æ¯ä¸ªç³»ç»ŸèŠ‚æ‹ï¼ˆSysTick
ä¸­æ–­ï¼‰å‘ç”Ÿæ—¶è¢«è°ƒç”¨ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œç³»ç»ŸèŠ‚æ‹å‘¨æœŸæ˜¯ 1 æ¯«ç§’ã€‚</p></li>
<li><p><code>lv_tick_inc(1);</code>: å‘Šè¯‰ LVGL å›¾å½¢åº“æ—¶é—´è¿‡å»äº† 1
æ¯«ç§’ã€‚LVGL å†…éƒ¨çš„åŠ¨ç”»ã€æ·¡å…¥æ·¡å‡ºç­‰æ•ˆæœéƒ½ä¾èµ–è¿™ä¸ªæ—¶é—´åŸºå‡†ã€‚è¿™æ˜¯å°† LVGL ä¸
FreeRTOS ç»“åˆçš„å…³é”®ä¸€æ­¥ã€‚</p></li>
<li><p>ç§’è¡¨é¡µé¢è®¡æ—¶:
<code>if(ui_TimerPageFlag)</code>åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨ç§’è¡¨é¡µé¢ï¼Œå¦‚æœæ˜¯ï¼Œå°±æ‰§è¡Œè®¡æ—¶é€»è¾‘ã€‚æŠŠè®¡æ—¶æ”¾åœ¨è¿™é‡Œå¯ä»¥ä¿è¯å…¶ç²¾åº¦ã€‚</p></li>
<li><p><code>user_HR_timecount+=1;</code>:
ä¸€ä¸ªå…¨å±€çš„å¿ƒç‡ç®—æ³•è®¡æ—¶å™¨ï¼Œæ¯æ¯«ç§’åŠ ä¸€ã€‚</p></li>
</ul>
<h3 id="lvhandlertask-å’Œ-wdogfeedtask"><code>LvHandlerTask()</code> å’Œ
<code>WDOGFeedTask()</code></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void LvHandlerTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">    // ...</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;</span><br><span class="line">        // ...</span><br><span class="line">		lv_task_handler();</span><br><span class="line">        osDelay(1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void WDOGFeedTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">    // ...</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;</span><br><span class="line">		WDOG_Feed();</span><br><span class="line">		WDOG_Enable();</span><br><span class="line">        osDelay(100);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="user_hardwareinittask">user_HardwareInitTask</h3>
<p>è¿™ä¸ªä»»åŠ¡çš„èŒè´£éå¸¸æ˜ç¡®ä¸”å…³é”®ï¼šå®Œæˆç³»ç»Ÿä¸­æ‰€æœ‰ç¡¬ä»¶å’Œæ ¸å¿ƒè½¯ä»¶æ¨¡å—çš„åˆå§‹åŒ–ã€‚å®ƒæ˜¯ä¸€ä¸ªâ€œä¸€æ¬¡æ€§â€ä»»åŠ¡ï¼Œåœ¨å®Œæˆæ‰€æœ‰åˆå§‹åŒ–å·¥ä½œåï¼Œä¼šè‡ªå·±åˆ é™¤è‡ªå·±ï¼Œé‡Šæ”¾å ç”¨çš„èµ„æºã€‚å®ƒçš„ä¼˜å…ˆçº§è¢«è®¾å¾—å¾ˆé«˜ï¼Œä»¥ç¡®ä¿åœ¨å…¶ä»–ä»»ä½•åº”ç”¨ä»»åŠ¡è¿è¡Œä¹‹å‰ï¼Œç¡¬ä»¶å·²ç»å‡†å¤‡å°±ç»ªã€‚
ä»»åŠ¡æ‰§è¡Œæµç¨‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void HardwareInitTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">        vTaskSuspendAll();</span><br></pre></td></tr></table></figure>
<p><code>vTaskSuspendAll();</code>: æŒ‚èµ·ï¼ˆæš‚åœï¼‰FreeRTOS
çš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªä¿æŠ¤æªæ–½ï¼Œç¡®ä¿åœ¨åˆå§‹åŒ–è¿™ç§å…³é”®ä¸”ä¸å¯ä¸­æ–­çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šæœ‰å…¶ä»–ä»»åŠ¡çªç„¶æ’å…¥æ‰§è¡Œï¼Œé¿å…äº†æ½œåœ¨çš„å†²çªã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// RTC Wake</span><br><span class="line">if(HAL_RTCEx_SetWakeUpTimer_IT(&amp;hrtc, 2000, RTC_WAKEUPCLOCK_RTCCLK_DIV16) != HAL_OK)</span><br><span class="line">&#123;</span><br><span class="line">  Error_Handler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é…ç½® RTC å”¤é†’å®šæ—¶å™¨: è®¾ç½®
RTCï¼ˆå®æ—¶æ—¶é’Ÿï¼‰çš„å”¤é†’å®šæ—¶å™¨ï¼Œå¹¶å¼€å¯ä¸­æ–­ã€‚è¿™æ˜¯å®ç°ä½åŠŸè€—ç¡çœ åèƒ½è¢«å®šæ—¶å”¤é†’çš„åŸºç¡€ã€‚é€šå¸¸å…ˆåˆå§‹åŒ–ä¸ä¾èµ–å…¶ä»–æ¨¡å—çš„åŸºç¡€å¤–è®¾ï¼ˆå¦‚æ—¶é’Ÿã€GPIOï¼‰ï¼Œç„¶åå†åˆå§‹åŒ–æ›´å¤æ‚çš„æ¨¡å—ã€‚è¿™ä¸ªé¡ºåºç¡®ä¿äº†ä¾èµ–å…³ç³»çš„æ­£ç¡®æ€§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// usart start</span><br><span class="line">HAL_UART_Receive_DMA(&amp;huart1,(uint8_t*)HardInt_receive_str,25);</span><br><span class="line">__HAL_UART_ENABLE_IT(&amp;huart1,UART_IT_IDLE);</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ä¸²å£æ¥æ”¶:</p>
<p><code>HAL_UART_Receive_DMA()</code>: ä»¥
DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰æ–¹å¼å¯åŠ¨ä¸²å£ 1
çš„æ•°æ®æ¥æ”¶ã€‚æ•°æ®ä¼šè¢«è‡ªåŠ¨å­˜å…¥<code>HardInt_receive_str</code>ç¼“å†²åŒºã€‚ä½¿ç”¨
DMA å¯ä»¥åœ¨æ¥æ”¶æ•°æ®æ—¶ä¸å ç”¨ CPUã€‚</p>
<p><code>__HAL_UART_ENABLE_IT(&amp;huart1,UART_IT_IDLE)</code>:
ä½¿èƒ½ä¸²å£çš„â€œç©ºé—²ä¸­æ–­â€ã€‚å½“ä¸²å£æ€»çº¿ä¸Šä¸€æ®µæ—¶é—´æ²¡æœ‰æ•°æ®ä¼ è¾“æ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªä¸­æ–­ï¼Œé€šå¸¸ç”¨æ¥åˆ¤æ–­ä¸€å¸§æ•°æ®æ˜¯å¦æ¥æ”¶å®Œæ¯•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// PWM Start</span><br><span class="line">HAL_TIM_PWM_Start(&amp;htim3,TIM_CHANNEL_3);</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ PWM: å¯åŠ¨å®šæ—¶å™¨ 3 çš„ PWMï¼ˆè„‰å†²å®½åº¦è°ƒåˆ¶ï¼‰åŠŸèƒ½ï¼Œè¿™é‡Œç”¨äºæ§åˆ¶ LCD
å±å¹•çš„èƒŒå…‰äº®åº¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// sys delay</span><br><span class="line">delay_init();</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ä¸€ä¸ªè‡ªå®šä¹‰çš„å»¶æ—¶å‡½æ•°åº“ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// power</span><br><span class="line">HWInterface.Power.Init();</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ç”µæºç®¡ç†éƒ¨åˆ†ï¼Œæ¯”å¦‚ ADC é‡‡é›†ç”µæ± ç”µå‹çš„ç›¸å…³é…ç½®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// key</span><br><span class="line">Key_Port_Init();</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–æŒ‰é”®æ‰€ä½¿ç”¨çš„ GPIO å¼•è„šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// sensors</span><br><span class="line">uint8_t num = 3;</span><br><span class="line">while(num &amp;&amp; HWInterface.AHT21.ConnectionError)</span><br><span class="line">&#123;</span><br><span class="line">  num--;</span><br><span class="line">  HWInterface.AHT21.ConnectionError = HWInterface.AHT21.Init();</span><br><span class="line">&#125;</span><br><span class="line">// ... (å…¶ä»–ä¼ æ„Ÿå™¨çš„åˆå§‹åŒ–ï¼Œé€»è¾‘ç±»ä¼¼) ...</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–æ‰€æœ‰ä¼ æ„Ÿå™¨:</p>
<p>è¿™é‡Œçš„è®¾è®¡éå¸¸å¥å£®ã€‚å®ƒä¸ºæ¯ä¸ªä¼ æ„Ÿå™¨çš„åˆå§‹åŒ–æä¾›äº† 3 æ¬¡é‡è¯•æœºä¼šã€‚</p>
<p>while(num &amp;&amp; HWInterface.AHT21.ConnectionError): åªè¦é‡è¯•æ¬¡æ•°
num æ²¡ç”¨å®Œï¼Œå¹¶ä¸”ä¼ æ„Ÿå™¨çš„è¿æ¥çŠ¶æ€ ConnectionError
ä»ç„¶æ˜¯é”™è¯¯ï¼Œå°±ç»§ç»­å°è¯•ã€‚</p>
<p>HWInterface.AHT21.Init(): è°ƒç”¨ç¡¬ä»¶è®¿é—®å±‚æä¾›çš„ä¼ æ„Ÿå™¨åˆå§‹åŒ–å‡½æ•°ã€‚</p>
<p>è¿™ä¸ªæ¨¡å¼è¢«ç”¨åœ¨äº†æ¸©æ¹¿åº¦(AHT21)ã€ç”µå­ç½—ç›˜(Ecompass)ã€æ°”å‹è®¡(Barometer)ã€è¿åŠ¨ä¼ æ„Ÿå™¨(IMU)å’Œå¿ƒç‡ä¼ æ„Ÿå™¨(HR_meter)ä¸Šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// EEPROM</span><br><span class="line">EEPROM_Init();</span><br><span class="line">if(!EEPROM_Check())</span><br><span class="line">&#123;</span><br><span class="line">    // ... (ä»EEPROMè¯»å–ä¸Šæ¬¡ä¿å­˜çš„è®¾ç½®å’Œæ­¥æ•°) ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–å¹¶è¯»å– EEPROM:</p>
<p><code>EEPROM_Init()</code>: åˆå§‹åŒ–ä¸ EEPROM é€šä¿¡çš„ I2C æ€»çº¿ã€‚</p>
<p><code>EEPROM_Check()</code>: æ£€æŸ¥ EEPROM
ä¸­æ˜¯å¦æœ‰åˆæ³•çš„æ ‡è®°ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚</p>
<p>å¦‚æœæ•°æ®æœ‰æ•ˆ (!EEPROM_Check()ä¸ºçœŸ)ï¼Œåˆ™ä» EEPROM
ä¸­è¯»å–ä¸Šæ¬¡å…³æœºå‰ä¿å­˜çš„ç”¨æˆ·è®¾ç½®ï¼ˆå¦‚æŠ¬è…•äº®å±å¼€å…³ï¼‰å’Œå½“å¤©çš„æ­¥æ•°ï¼Œå¹¶æ¢å¤åˆ°ç³»ç»Ÿå˜é‡å’Œ
MPU6050 çš„è®¡æ­¥å™¨ä¸­ã€‚è¿™ä¿è¯äº†ç”¨æˆ·è®¾ç½®å’Œè®¡æ­¥æ•°æ®çš„æŒä¹…åŒ–ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// BLE</span><br><span class="line">HWInterface.BLE.Init();</span><br><span class="line">HWInterface.BLE.Disable();</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–è“ç‰™æ¨¡å—ï¼Œå¹¶å…ˆå°†å…¶ç½®äºç¦ç”¨çŠ¶æ€ä»¥èŠ‚çœåŠŸè€—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// touch</span><br><span class="line">CST816_GPIO_Init();</span><br><span class="line">CST816_RESET();</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–è§¦æ‘¸å±æ§åˆ¶å™¨ CST816 çš„ GPIO å¹¶å¯¹å…¶è¿›è¡Œå¤ä½ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// lcd</span><br><span class="line">LCD_Init();</span><br><span class="line">LCD_Fill(0,0, LCD_W, LCD_H, BLACK);</span><br><span class="line">// ... (æ˜¾ç¤ºå¼€æœºæ¬¢è¿ç•Œé¢) ...</span><br><span class="line">delay_ms(1000);</span><br><span class="line">LCD_Fill(0, LCD_H/2-24, LCD_W, LCD_H/2+49, BLACK);</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–å¹¶æ˜¾ç¤ºå¼€æœºåŠ¨ç”»:</p>
<p><code>LCD_Init()</code>: åˆå§‹åŒ– LCD å±å¹•æ§åˆ¶å™¨ã€‚</p>
<p><code>LCD_Fill(...)</code>: å¯¹å±å¹•è¿›è¡Œæ¸…å±ï¼ˆå¡«å……ä¸ºé»‘è‰²ï¼‰ã€‚</p>
<p><code>LCD_ShowString(...)</code>: åœ¨å±å¹•ä¸Šæ˜¾ç¤º â€œWelcome!â€
å’Œç‰ˆæœ¬å·ä¿¡æ¯ã€‚</p>
<p><code>delay_ms(1000)</code>: æ˜¾ç¤º 1 ç§’é’Ÿã€‚</p>
<p><code>LCD_Fill(...)</code>: å†æ¬¡æ¸…ç©ºæ¬¢è¿ä¿¡æ¯ï¼Œä¸ºæ˜¾ç¤ºä¸» UI
åšå‡†å¤‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// ui</span><br><span class="line">// LVGL init</span><br><span class="line">lv_init();</span><br><span class="line">lv_port_disp_init();</span><br><span class="line">lv_port_indev_init();</span><br><span class="line">ui_init();</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ– LVGL å›¾å½¢åº“:</p>
<p><code>lv_init()</code>: åˆå§‹åŒ– LVGL åº“æœ¬èº«ã€‚</p>
<p><code>lv_port_disp_init()</code>: åˆå§‹åŒ–æ˜¾ç¤ºç«¯å£ï¼Œå³å‘Šè¯‰ LVGL
å¦‚ä½•å°†å®ƒè®¡ç®—å¥½çš„åƒç´ ç‚¹åˆ·æ–°åˆ° LCD å±å¹•ä¸Šã€‚</p>
<p><code>lv_port_indev_init()</code>: åˆå§‹åŒ–è¾“å…¥è®¾å¤‡ç«¯å£ï¼Œå³å‘Šè¯‰ LVGL
å¦‚ä½•ä»è§¦æ‘¸å±æˆ–æŒ‰é”®è·å–è¾“å…¥ã€‚</p>
<p><code>ui_init()</code>: åˆå§‹åŒ–ç”± UI è®¾è®¡å·¥å…·ï¼ˆå¦‚ SquareLine
Studioï¼‰ç”Ÿæˆçš„æ‰€æœ‰ UI é¡µé¢å’Œæ§ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        xTaskResumeAll();</span><br><span class="line">		vTaskDelete(NULL);</span><br><span class="line">		osDelay(500);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»»åŠ¡ç»“æŸ:</p>
<p><code>xTaskResumeAll()</code>: æ¢å¤ FreeRTOS
çš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚æ­¤æ—¶ï¼Œæ‰€æœ‰ç¡¬ä»¶å’Œè½¯ä»¶æ¨¡å—éƒ½å·²å‡†å¤‡å°±ç»ªï¼Œå…¶ä»–ä»»åŠ¡å¯ä»¥å®‰å…¨åœ°å¼€å§‹è¿è¡Œäº†ã€‚</p>
<p><code>vTaskDelete(NULL)</code>:
åˆ é™¤å½“å‰ä»»åŠ¡ã€‚å› ä¸ºåˆå§‹åŒ–å·¥ä½œå·²ç»å…¨éƒ¨å®Œæˆï¼Œè¿™ä¸ªä»»åŠ¡æ²¡æœ‰å­˜åœ¨çš„å¿…è¦äº†ï¼Œåˆ é™¤å®ƒå¯ä»¥å›æ”¶å…¶å ç”¨çš„å †æ ˆå†…å­˜ã€‚</p>
<h2 id="user_runmodetasks">user_RunModeTasks</h2>
<p>è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†ç®¡ç†æ‰‹è¡¨è¿è¡Œæ¨¡å¼çš„æ ¸å¿ƒé€»è¾‘ï¼Œç‰¹åˆ«æ˜¯ä»æ­£å¸¸è¿è¡Œæ¨¡å¼è¿›å…¥ä¸åŒçº§åˆ«çš„ä½åŠŸè€—æ¨¡å¼ã€‚å®ƒæ˜¯æ‰‹è¡¨èƒ½å¤Ÿé•¿æ—¶é—´ç»­èˆªçš„å…³é”®ã€‚ä¸»è¦åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šIdleEnterTaskï¼ˆè¿›å…¥ç©ºé—²æ¨¡å¼ï¼‰ã€StopEnterTaskï¼ˆè¿›å…¥åœæ­¢æ¨¡å¼ï¼‰å’Œä¸€ä¸ªè½¯ä»¶å®šæ—¶å™¨å›è°ƒå‡½æ•°
IdleTimerCallbackã€‚</p>
<h3 id="idletimercallback---ç©ºé—²å®šæ—¶å™¨å›è°ƒ">1. IdleTimerCallback() -
ç©ºé—²å®šæ—¶å™¨å›è°ƒ</h3>
<p>è¿™ä¸ªå‡½æ•°ä¸æ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¯ 100 æ¯«ç§’è¢« RTOS
å†…æ ¸è°ƒç”¨ä¸€æ¬¡çš„è½¯ä»¶å®šæ—¶å™¨å›è°ƒå‡½æ•°ã€‚å®ƒæ˜¯æ‰€æœ‰ä½åŠŸè€—é€»è¾‘çš„èµ·ç‚¹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void IdleTimerCallback(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	IdleTimerCount+=1;</span><br><span class="line">	//make sure the LightOffTime&lt;TurnOffTime</span><br><span class="line">	if(IdleTimerCount == (ui_LTimeValue*10))</span><br><span class="line">	&#123;</span><br><span class="line">		uint8_t Idlestr=0;</span><br><span class="line">		//send the Light off message</span><br><span class="line">		osMessageQueuePut(Idle_MessageQueue, &amp;Idlestr, 0, 1);</span><br><span class="line">	&#125;</span><br><span class="line">	if(IdleTimerCount == (ui_TTimeValue*10))</span><br><span class="line">	&#123;</span><br><span class="line">		uint8_t Stopstr = 1;</span><br><span class="line">		IdleTimerCount  = 0;</span><br><span class="line">		//send the Stop message</span><br><span class="line">		osMessageQueuePut(Stop_MessageQueue, &amp;Stopstr, 0, 1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IdleTimerCount+=1;</code>: IdleTimerCount
æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¯æ¬¡å›è°ƒï¼ˆæ¯ 100msï¼‰åŠ 
1ï¼Œç”¨äºè®°å½•ç”¨æˆ·æ— æ“ä½œçš„æ—¶é—´ã€‚å½“ç”¨æˆ·æœ‰ä»»ä½•æ“ä½œï¼ˆè§¦æ‘¸ã€æŒ‰é”®ï¼‰æ—¶ï¼Œè¿™ä¸ªè®¡æ•°å™¨ä¼šè¢«æ¸…é›¶ã€‚</p>
<p><code>if(IdleTimerCount == (ui_LTimeValue*10))</code>:
åˆ¤æ–­æ— æ“ä½œæ—¶é—´æ˜¯å¦è¾¾åˆ°äº†ç”¨æˆ·è®¾å®šçš„â€œè‡ªåŠ¨æš—å±â€æ—¶é—´ï¼ˆui_LTimeValue æ˜¯ä» UI
è®¾ç½®ç•Œé¢è·å–çš„ç§’æ•°ï¼‰ã€‚</p>
<p><code>osMessageQueuePut(Idle_MessageQueue, &amp;Idlestr, 0, 1);</code>:
å¦‚æœè¾¾åˆ°æ—¶é—´ï¼Œå°±å‘ Idle_MessageQueue å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œé€šçŸ¥ IdleEnterTask
ä»»åŠ¡è¯¥æ‰§è¡Œæš—å±æ“ä½œäº†ã€‚</p>
<p><code>if(IdleTimerCount == (ui_TTimeValue*10))</code>:
åˆ¤æ–­æ— æ“ä½œæ—¶é—´æ˜¯å¦è¾¾åˆ°äº†ç”¨æˆ·è®¾å®šçš„â€œè‡ªåŠ¨ä¼‘çœ â€æ—¶é—´ï¼ˆui_TTimeValueï¼‰ã€‚</p>
<p><code>osMessageQueuePut(Stop_MessageQueue, &amp;Stopstr, 0, 1);</code>:
å¦‚æœè¾¾åˆ°æ—¶é—´ï¼Œå°±å‘ Stop_MessageQueue å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œé€šçŸ¥ StopEnterTask
ä»»åŠ¡è¯¥è®©ç³»ç»Ÿè¿›å…¥æ·±åº¦ç¡çœ ï¼ˆSTOP æ¨¡å¼ï¼‰äº†ã€‚</p>
<p><code>IdleTimerCount = 0;</code>: å‘é€æ¶ˆæ¯åï¼Œå°†è®¡æ•°å™¨æ¸…é›¶ã€‚</p>
<h3 id="idleentertask---ç©ºé—²æ¨¡å¼ä»»åŠ¡">2. IdleEnterTask() -
ç©ºé—²æ¨¡å¼ä»»åŠ¡</h3>
<p>è¿™ä¸ªä»»åŠ¡ç­‰å¾…å¤„ç†â€œç©ºé—²â€å’Œâ€œé€€å‡ºç©ºé—²â€çš„æ¶ˆæ¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">void IdleEnterTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t Idlestr=0;</span><br><span class="line">	uint8_t IdleBreakstr=0;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		//light get dark</span><br><span class="line">		if(osMessageQueueGet(Idle_MessageQueue,&amp;Idlestr,NULL,1)==osOK)</span><br><span class="line">		&#123;</span><br><span class="line">			LCD_Set_Light(5);</span><br><span class="line">		&#125;</span><br><span class="line">		//resume light if light got dark and idle state breaked by key pressing or screen touching</span><br><span class="line">		if(osMessageQueueGet(IdleBreak_MessageQueue,&amp;IdleBreakstr,NULL,1)==osOK)</span><br><span class="line">		&#123;</span><br><span class="line">			IdleTimerCount = 0;</span><br><span class="line">			LCD_Set_Light(ui_LightSliderValue);</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(10);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>if(osMessageQueueGet(Idle_MessageQueue, ...)==osOK)</code>:
å°è¯•ä» Idle_MessageQueue è·å–æ¶ˆæ¯ã€‚å¦‚æœè·å–æˆåŠŸï¼ˆç”± IdleTimerCallback
å‘é€çš„ï¼‰ï¼Œè¯´æ˜éœ€è¦è¿›å…¥â€œç©ºé—²â€æ¨¡å¼ã€‚</p>
<p><code>LCD_Set_Light(5);</code>:
å°†å±å¹•èƒŒå…‰äº®åº¦è°ƒåˆ°å¾ˆä½çš„æ°´å¹³ï¼ˆå˜æš—ï¼‰ï¼Œä½†å±å¹•å¹¶æœªå®Œå…¨å…³é—­ã€‚</p>
<p><code>if(osMessageQueueGet(IdleBreak_MessageQueue, ...)==osOK)</code>:
å°è¯•ä» IdleBreak_MessageQueue
è·å–æ¶ˆæ¯ã€‚è¿™ä¸ªæ¶ˆæ¯ç”±æŒ‰é”®ã€è§¦æ‘¸ç­‰ä¸­æ–­è§¦å‘ï¼Œè¡¨ç¤ºç”¨æˆ·è¿›è¡Œäº†æ“ä½œï¼Œéœ€è¦â€œé€€å‡ºç©ºé—²â€ã€‚</p>
<p><code>IdleTimerCount = 0;</code>: é‡ç½®ç©ºé—²è®¡æ—¶å™¨ã€‚</p>
<p><code>LCD_Set_Light(ui_LightSliderValue);</code>:
å°†å±å¹•äº®åº¦æ¢å¤åˆ°ç”¨æˆ·è®¾å®šçš„æ­£å¸¸äº®åº¦ã€‚</p>
<h3 id="stopentertask---åœæ­¢ä¼‘çœ æ¨¡å¼ä»»åŠ¡">3. StopEnterTask() -
åœæ­¢ï¼ˆä¼‘çœ ï¼‰æ¨¡å¼ä»»åŠ¡</h3>
<p>è¿™æ˜¯å®ç°æ·±åº¦ç¡çœ çš„æ ¸å¿ƒä»»åŠ¡ï¼Œé€»è¾‘ä¹Ÿæœ€å¤æ‚ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">void StopEnterTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	// ...</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		if(osMessageQueueGet(Stop_MessageQueue,&amp;Stopstr,NULL,0)==osOK)</span><br><span class="line">		&#123;</span><br><span class="line">			/*************************** your operations before sleep***************************/</span><br><span class="line">			sleep:</span><br><span class="line">			IdleTimerCount = 0;</span><br><span class="line">			//sensors</span><br><span class="line">			//usart</span><br><span class="line">			HAL_UART_MspDeInit(&amp;huart1);</span><br><span class="line">			//lcd</span><br><span class="line">			LCD_RES_Clr();</span><br><span class="line">			LCD_Close_Light();</span><br><span class="line">			//touch</span><br><span class="line">			CST816_Sleep();</span><br><span class="line"></span><br><span class="line">			/****************************** enter wakeup operations *****************************/</span><br><span class="line">			vTaskSuspendAll();</span><br><span class="line">			WDOG_Disnable();</span><br><span class="line">			CLEAR_BIT(SysTick-&gt;CTRL, SysTick_CTRL_TICKINT_Msk);</span><br><span class="line">			HAL_PWR_EnterSTOPMode(PWR_MAINREGULATOR_ON,PWR_STOPENTRY_WFI);</span><br><span class="line"></span><br><span class="line">			//here is the sleep period</span><br><span class="line"></span><br><span class="line">			/****************************** quit wakeup operations *****************************/</span><br><span class="line">			SET_BIT(SysTick-&gt;CTRL, SysTick_CTRL_TICKINT_Msk);</span><br><span class="line">			HAL_SYSTICK_Config(SystemCoreClock / (1000U / uwTickFreq));</span><br><span class="line">			SystemClock_Config();</span><br><span class="line">			WDOG_Feed();</span><br><span class="line">			xTaskResumeAll();</span><br><span class="line"></span><br><span class="line">			/****************************** your wakeup operations *****************************/</span><br><span class="line">			// ... (å”¤é†’åçš„é€»è¾‘åˆ¤æ–­) ...</span><br><span class="line">			//usart</span><br><span class="line">			HAL_UART_MspInit(&amp;huart1);</span><br><span class="line">			//lcd</span><br><span class="line">			LCD_Init();</span><br><span class="line">			LCD_Set_Light(ui_LightSliderValue);</span><br><span class="line">			//touch</span><br><span class="line">			CST816_Wakeup();</span><br><span class="line">			// ...</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(100);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>if(osMessageQueueGet(Stop_MessageQueue, ...)==osOK)</code>:
ç­‰å¾…è¿›å…¥ STOP æ¨¡å¼çš„æ¶ˆæ¯ã€‚</p>
<p>A. è¿›å…¥ä¼‘çœ å‰çš„å‡†å¤‡:</p>
<p><code>sleep:</code>: è¿™æ˜¯ä¸€ä¸ª goto
æ ‡ç­¾ï¼Œç”¨äºåœ¨æŸäº›å”¤é†’æ¡ä»¶ä¸‹ç«‹å³é‡æ–°è¿›å…¥ç¡çœ ã€‚</p>
<p><code>HAL_UART_MspDeInit(&amp;huart1);</code>:
ååˆå§‹åŒ–ä¸²å£ï¼Œå…³é—­å…¶æ—¶é’Ÿå’Œ GPIO ä»¥çœç”µã€‚</p>
<p><code>LCD_RES_Clr(); LCD_Close_Light();</code>: å…³é—­ LCD
å±å¹•ç”µæºå’ŒèƒŒå…‰ã€‚</p>
<p><code>CST816_Sleep();</code>: è®©è§¦æ‘¸èŠ¯ç‰‡è¿›å…¥ç¡çœ æ¨¡å¼ã€‚</p>
<p>B. è¿›å…¥ STOP æ¨¡å¼:</p>
<p><code>vTaskSuspendAll();</code>: æŒ‚èµ·ä»»åŠ¡è°ƒåº¦å™¨ã€‚</p>
<p><code>WDOG_Disnable();</code>:
ç¦ç”¨çœ‹é—¨ç‹—ã€‚è¿™æ˜¯ä½¿ç”¨å¤–éƒ¨çœ‹é—¨ç‹—çš„å…³é”®ä¼˜åŠ¿ï¼Œå…è®¸ MCU
æ·±åº¦ç¡çœ è€Œæ— éœ€é¢‘ç¹å”¤é†’å–‚ç‹—ã€‚å¦‚æœæ˜¯å†…éƒ¨çœ‹é—¨ç‹—ï¼Œå¼€å¯åæ— æ³•è½¯ä»¶å…³é—­ã€‚</p>
<p><code>CLEAR_BIT(SysTick-&gt;CTRL, ...)</code>: å…³é—­ SysTick
ä¸­æ–­ã€‚è¿™æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ SysTick ä¸­æ–­ä¼šç«‹å³å”¤é†’ MCUã€‚</p>
<p><code>HAL_PWR_EnterSTOPMode(...)</code>: æ‰§è¡Œæ­¤è¡Œä»£ç åï¼ŒCPU
å°†åœæ­¢è¿è¡Œï¼Œè¿›å…¥ STOP æ¨¡å¼ï¼Œç­‰å¾…å”¤é†’äº‹ä»¶ï¼ˆWFI: Wait For
Interruptï¼‰ã€‚</p>
<p>C. ä» STOP æ¨¡å¼å”¤é†’åçš„æ¢å¤:</p>
<p>ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ä¸€ä¸ªå”¤é†’ä¸­æ–­ï¼ˆå¦‚æŒ‰é”®ã€RTCã€å……ç”µæ’å…¥ï¼‰å·²ç»å‘ç”Ÿã€‚</p>
<p><code>SET_BIT(SysTick-&gt;CTRL, ...)</code>: é‡æ–°å¼€å¯ SysTick
ä¸­æ–­ã€‚</p>
<p><code>SystemClock_Config()</code>;: é‡æ–°é…ç½®ç³»ç»Ÿæ—¶é’Ÿã€‚å› ä¸ºä» STOP
æ¨¡å¼å”¤é†’åï¼Œç³»ç»Ÿä¼šä½¿ç”¨å†…éƒ¨çš„ HSI æ—¶é’Ÿï¼Œéœ€è¦é‡æ–°é…ç½®ä¸ºé«˜é€Ÿçš„ HSE
æ—¶é’Ÿã€‚</p>
<p><code>WDOG_Feed();</code>: å–‚ä¸€æ¬¡ç‹—ï¼Œè¡¨ç¤ºç³»ç»Ÿå·²æ¢å¤ã€‚</p>
<p><code>xTaskResumeAll();</code>: æ¢å¤ä»»åŠ¡è°ƒåº¦å™¨ã€‚</p>
<p>D. å”¤é†’åçš„ä¸šåŠ¡é€»è¾‘:</p>
<p>åˆ¤æ–­å”¤é†’æº:
<code>if(HWInterface.IMU.wrist_is_enabled)</code>æ£€æŸ¥æ˜¯å¦æ˜¯æŠ¬è…•å”¤é†’ï¼Œ<code>if(!KEY1 || KEY2 || ...)</code>æ£€æŸ¥æ˜¯å¦æ˜¯æŒ‰é”®æˆ–å……ç”µå”¤é†’ã€‚</p>
<p><code>goto sleep;</code>:
å¦‚æœå”¤é†’æ¡ä»¶ä¸æ»¡è¶³ï¼ˆæ¯”å¦‚æŠ¬è…•äº®å±åï¼Œç”¨æˆ·åˆè¿…é€Ÿæ”¾ä¸‹æ‰‹è…•ï¼‰ï¼Œåˆ™ä½¿ç”¨ goto
è¯­å¥ç›´æ¥è·³å› sleep
æ ‡ç­¾ï¼Œè®©ç³»ç»Ÿç«‹å³é‡æ–°è¿›å…¥ç¡çœ ï¼Œé¿å…äº†ä¸å¿…è¦çš„äº®å±ã€‚</p>
<p>é‡æ–°åˆå§‹åŒ–å¤–è®¾: å¦‚æœå†³å®šæ­£å¸¸å”¤é†’ï¼Œåˆ™éœ€è¦é‡æ–°åˆå§‹åŒ–ä¹‹å‰å…³é—­çš„å¤–è®¾ï¼Œå¦‚
HAL_UART_MspInit, LCD_Init, CST816_Wakeup ç­‰ã€‚</p>
<p><code>osMessageQueuePut(HomeUpdata_MessageQueue, ...)</code>:
å‘é€æ¶ˆæ¯ï¼Œé€šçŸ¥ä¸»ç•Œé¢æ›´æ–°æ•°æ®ï¼ˆå› ä¸ºç¡çœ æœŸé—´æ—¶é—´ç­‰ä¿¡æ¯å¯èƒ½å·²å˜åŒ–ï¼‰ã€‚</p>
<h3 id="user_keytask">user_KeyTask</h3>
<p>è¿™ä¸ªä»»åŠ¡çš„èŒè´£éå¸¸ä¸“ä¸€ï¼šæŒç»­æ‰«æç‰©ç†æŒ‰é”®çš„çŠ¶æ€ï¼Œå¹¶å°†æŒ‰é”®äº‹ä»¶é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™å…¶ä»–ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚
ä»»åŠ¡æ‰§è¡Œæµç¨‹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">void KeyTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t keystr=0;</span><br><span class="line">	uint8_t Stopstr=0;</span><br><span class="line">	uint8_t IdleBreakstr=0;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		switch(KeyScan(0))</span><br><span class="line">		&#123;</span><br><span class="line">			case 1:</span><br><span class="line">				keystr = 1;</span><br><span class="line">				osMessageQueuePut(Key_MessageQueue, &amp;keystr, 0, 1);</span><br><span class="line">				osMessageQueuePut(IdleBreak_MessageQueue, &amp;IdleBreakstr, 0, 1);</span><br><span class="line">				break;</span><br><span class="line"></span><br><span class="line">			case 2:</span><br><span class="line">				if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_HomePage)</span><br><span class="line">				&#123;</span><br><span class="line">					osMessageQueuePut(Stop_MessageQueue, &amp;Stopstr, 0, 1);</span><br><span class="line">				&#125;</span><br><span class="line">				else</span><br><span class="line">				&#123;</span><br><span class="line">					keystr = 2;</span><br><span class="line">					osMessageQueuePut(Key_MessageQueue, &amp;keystr, 0, 1);</span><br><span class="line">					osMessageQueuePut(IdleBreak_MessageQueue, &amp;IdleBreakstr, 0, 1);</span><br><span class="line">				&#125;</span><br><span class="line">				break;</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>osMessageQueuePut(Key_MessageQueue, &amp;keystr, 0, 1);</code>:
å°†æŒ‰é”®æ¶ˆæ¯ 1 å‘é€åˆ°
Key_MessageQueueã€‚ScrRenewTaskï¼ˆå±å¹•åˆ·æ–°ä»»åŠ¡ï¼‰ä¼šæ¥æ”¶è¿™ä¸ªæ¶ˆæ¯æ¥æ‰§è¡Œç›¸åº”çš„é¡µé¢åˆ‡æ¢ã€‚</p>
<p><code>osMessageQueuePut(IdleBreak_MessageQueue, &amp;IdleBreakstr, 0, 1);</code>:
åŒæ—¶ï¼Œå‘ IdleBreak_MessageQueue
å‘é€ä¸€ä¸ªâ€œç©ºé—²ä¸­æ–­â€æ¶ˆæ¯ã€‚è¿™éå¸¸é‡è¦ï¼Œå®ƒå‘Šè¯‰ IdleEnterTask
ä»»åŠ¡ï¼šâ€œç”¨æˆ·æœ‰æ“ä½œäº†â€ï¼Œä»è€Œé‡ç½®ç©ºé—²è®¡æ—¶å™¨å¹¶ç‚¹äº®å±å¹•ã€‚</p>
<p><code>if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_HomePage)</code>:
åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨ä¸»ç•Œé¢ã€‚</p>
<p><code>osMessageQueuePut(Stop_MessageQueue, &amp;Stopstr, 0, 1);</code>:
å¦‚æœåœ¨ä¸»ç•Œé¢ï¼Œé‚£ä¹ˆè¿™ä¸ªæŒ‰é”®çš„åŠŸèƒ½å°±æ˜¯â€œé”å±/ä¼‘çœ â€ã€‚å®ƒç›´æ¥å‘
Stop_MessageQueue å‘é€æ¶ˆæ¯ï¼Œé€šçŸ¥ StopEnterTask ä»»åŠ¡è®©ç³»ç»Ÿè¿›å…¥ STOP
æ¨¡å¼ã€‚</p>
<p>å¦‚æœä¸åœ¨ä¸»ç•Œé¢ã€‚</p>
<p><code>osMessageQueuePut(Key_MessageQueue, &amp;keystr, 0, 1);</code>:
å°†æŒ‰é”®æ¶ˆæ¯ 2 å‘é€åˆ° Key_MessageQueueï¼ŒScrRenewTask
ä¼šæ¥æ”¶å®ƒå¹¶æ‰§è¡Œâ€œè¿”å›ä¸Šä¸€é¡µâ€çš„æ“ä½œã€‚</p>
<p><code>osMessageQueuePut(IdleBreak_MessageQueue, &amp;IdleBreakstr, 0, 1);</code>:
åŒæ ·ï¼Œå‘é€â€œç©ºé—²ä¸­æ–­â€æ¶ˆæ¯æ¥ç‚¹äº®å±å¹•å’Œé‡ç½®è®¡æ—¶å™¨ã€‚</p>
<p><code>osDelay(1);</code>: æ¯æ¬¡å¾ªç¯åå»¶æ—¶ 1 æ¯«ç§’ã€‚è¿™å¯ä»¥é˜²æ­¢ä»»åŠ¡
100%å ç”¨ CPUï¼Œè®©å…¶ä»–ä»»åŠ¡ä¹Ÿæœ‰æœºä¼šè¿è¡Œã€‚åŒæ—¶ä¹Ÿèµ·åˆ°äº†æŒ‰é”®æ¶ˆæŠ–çš„ä½œç”¨ã€‚</p>
<h3 id="user_scrrenewtask">user_ScrRenewTask</h3>
<p>è¿™ä¸ªä»»åŠ¡çš„è§’è‰²æ˜¯æŒ‰é”®äº‹ä»¶çš„å“åº”è€…å’Œ UI é¡µé¢å¯¼èˆªçš„æ‰§è¡Œè€…ã€‚å®ƒä¸“é—¨ç­‰å¾…ä»
Key_MessageQueue ä¸­ä¼ æ¥çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®æ¶ˆæ¯å†…å®¹è°ƒç”¨ PageManager
æä¾›çš„å‡½æ•°æ¥æ›´æ–°å±å¹•æ˜¾ç¤ºã€‚</p>
<p>ä»»åŠ¡æ‰§è¡Œæµç¨‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">void ScrRenewTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t keystr=0;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		if(osMessageQueueGet(Key_MessageQueue,&amp;keystr,NULL,0)==osOK)</span><br><span class="line">		&#123;</span><br><span class="line">			//key1 pressed</span><br><span class="line">			if(keystr == 1)</span><br><span class="line">			&#123;</span><br><span class="line">				Page_Back();</span><br><span class="line">				if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_MenuPage)</span><br><span class="line">				&#123;</span><br><span class="line">					//HR sensor sleep</span><br><span class="line">					EM7028_hrs_DisEnable();</span><br><span class="line">					//sensor sleep</span><br><span class="line">					LSM303DLH_Sleep();</span><br><span class="line">					// SPL_Sleep();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			//key2 pressed</span><br><span class="line">			else if(keystr == 2)</span><br><span class="line">			&#123;</span><br><span class="line">				Page_Back_Bottom();</span><br><span class="line">				//HR sensor sleep</span><br><span class="line">				EM7028_hrs_DisEnable();</span><br><span class="line">  				//sensor sleep</span><br><span class="line">				LSM303DLH_Sleep();</span><br><span class="line">				// SPL_Sleep();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(10);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>uint8_t keystr=0;</code>:
å®šä¹‰ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œç”¨äºå­˜å‚¨ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶åˆ°çš„æŒ‰é”®å€¼ã€‚</p>
<p><code>if(osMessageQueueGet(Key_MessageQueue, &amp;keystr, NULL, 0) == osOK)</code>:
è¿™æ˜¯ä»»åŠ¡çš„æ ¸å¿ƒã€‚å®ƒå°è¯•ä»<code>Key_MessageQueue</code>è·å–ä¸€ä¸ªæ¶ˆæ¯ã€‚</p>
<p><code>NULL, 0</code>:
è¡¨ç¤ºå¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œä»»åŠ¡ä¸ä¼šè¢«é˜»å¡ï¼Œä¼šç«‹åˆ»å‘ä¸‹æ‰§è¡Œã€‚</p>
<p><code>== osOK</code>: åˆ¤æ–­æ˜¯å¦æˆåŠŸè·å–åˆ°äº†æ¶ˆæ¯ã€‚</p>
<p><code>Page_Back();</code>: è°ƒç”¨é¡µé¢ç®¡ç†å™¨çš„â€œè¿”å›ä¸Šä¸€é¡µâ€å‡½æ•°ã€‚</p>
<p><code>if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_MenuPage)</code>:
æ£€æŸ¥è¿”å›åï¼Œå½“å‰é¡µé¢æ˜¯å¦æ˜¯èœå•é¡µã€‚</p>
<p><code>EM7028_hrs_DisEnable(); ...</code>:
å¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°è®©å¿ƒç‡ã€ç”µå­ç½—ç›˜ç­‰ä¼ æ„Ÿå™¨è¿›å…¥ç¡çœ æ¨¡å¼ï¼Œä»¥èŠ‚çœç”µé‡ã€‚è¿™æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œå› ä¸ºåœ¨èœå•é¡µé€šå¸¸ä¸éœ€è¦è¿™äº›ä¼ æ„Ÿå™¨å·¥ä½œã€‚</p>
<p><code>Page_Back_Bottom();</code>:
è°ƒç”¨é¡µé¢ç®¡ç†å™¨çš„â€œç›´æ¥è¿”å›åˆ°æœ€åº•éƒ¨çš„é¡µé¢ï¼ˆä¸»é¡µï¼‰â€å‡½æ•°ã€‚</p>
<p><code>EM7028_hrs_DisEnable(); ...</code>:
åŒæ ·ï¼Œåœ¨è¿”å›ä¸»é¡µåï¼Œä¹Ÿè®©æ‰€æœ‰éå¿…è¦çš„ä¼ æ„Ÿå™¨è¿›å…¥ç¡çœ æ¨¡å¼ã€‚</p>
<p><code>osDelay(10);</code>: æ¯æ¬¡å¾ªç¯å»¶æ—¶ 10 æ¯«ç§’ï¼Œé‡Šæ”¾ CPU
ç»™å…¶ä»–ä»»åŠ¡ã€‚</p>
<p>è¿™ä¸ªä»»åŠ¡æ¸…æ™°åœ°å±•ç¤ºäº†ä»»åŠ¡é—´åä½œçš„æ¨¡å¼ï¼šKeyTask
ä½œä¸ºç”Ÿäº§è€…ï¼ŒScrRenewTask ä½œä¸ºæ¶ˆè´¹è€…ï¼Œé€šè¿‡ Key_MessageQueue
è¿™ä¸ªâ€œç®¡é“â€è§£è€¦äº†æŒ‰é”®æ£€æµ‹å’Œ UI å“åº”ï¼Œä½¿å¾—ä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ã€‚</p>
<h3 id="user_chargchecktask">user_ChargCheckTask</h3>
<p>è¿™ä¸ªä»»åŠ¡ä¸“é—¨è´Ÿè´£å¤„ç†ä¸å……ç”µç›¸å…³çš„é€»è¾‘ã€‚å®ƒé€šè¿‡ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­æ ‡å¿—ä½æ¥è¢«åŠ¨è§¦å‘ï¼Œè€Œä¸æ˜¯æŒç»­è½®è¯¢ï¼Œè¿™æ˜¯ä¸€ç§é«˜æ•ˆçš„è®¾è®¡ã€‚</p>
<p>ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void ChargPageEnterTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		// ç¡¬ä»¶ä¸­æ–­å‘ç”Ÿ</span><br><span class="line">		if(HardInt_Charg_flag)</span><br><span class="line">		&#123;</span><br><span class="line">			IdleTimerCount = 0;</span><br><span class="line">			HardInt_Charg_flag = 0;</span><br><span class="line">			if((ChargeCheck()) &amp;&amp; (Page_Get_NowPage()-&gt;page_obj != &amp;ui_ChargPage))</span><br><span class="line">			&#123;</span><br><span class="line">				Page_Load(&amp;Page_Charg);</span><br><span class="line">			&#125;</span><br><span class="line">			else if((!ChargeCheck()) &amp;&amp; (Page_Get_NowPage()-&gt;page_obj == &amp;ui_ChargPage))</span><br><span class="line">			&#123;</span><br><span class="line">				Page_Back();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(500);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>if(HardInt_Charg_flag)</code>:
è¿™æ˜¯ä»»åŠ¡çš„æ ¸å¿ƒè§¦å‘æ¡ä»¶ã€‚<code>HardInt_Charg_flag</code>æ˜¯ä¸€ä¸ªå…¨å±€æ ‡å¿—ä½ï¼Œå®ƒåº”è¯¥åœ¨ä¸€ä¸ª
GPIO çš„å¤–éƒ¨ä¸­æ–­æœåŠ¡ç¨‹åºï¼ˆISRï¼‰ä¸­è¢«è®¾ç½®ä¸º
1ã€‚è¿™ä¸ªä¸­æ–­å¼•è„šè¿æ¥åˆ°å……ç”µæ£€æµ‹ç”µè·¯ä¸Šã€‚å½“ç”¨æˆ·æ’å…¥æˆ–æ‹”ä¸‹å……ç”µå™¨æ—¶ï¼Œç”µå¹³å˜åŒ–è§¦å‘ä¸­æ–­ï¼Œä»è€Œâ€œå”¤é†’â€è¿™ä¸ªä»»åŠ¡ã€‚</p>
<p><code>IdleTimerCount = 0;</code>:
åªè¦æ£€æµ‹åˆ°å……ç”µçŠ¶æ€å˜åŒ–ï¼Œå°±é‡ç½®ç©ºé—²è®¡æ—¶å™¨ï¼Œé˜²æ­¢æ‰‹è¡¨åœ¨å……ç”µæ—¶è‡ªåŠ¨ä¼‘çœ ã€‚</p>
<p><code>HardInt_Charg_flag = 0</code>;:
å¤„ç†ä¸­æ–­åï¼Œç«‹å³æ¸…é™¤æ ‡å¿—ä½ï¼Œä¸ºä¸‹ä¸€æ¬¡ä¸­æ–­åšå‡†å¤‡ã€‚è¿™æ˜¯ä¸€ä¸ªå¿…é¡»çš„æ­¥éª¤ã€‚</p>
<p><code>if((ChargeCheck()) &amp;&amp; (Page_Get_NowPage()-&gt;page_obj != &amp;ui_ChargPage))</code>:</p>
<p><code>ChargeCheck()</code>:
è°ƒç”¨ä¸€ä¸ªåº•å±‚å‡½æ•°æ¥å†æ¬¡ç¡®è®¤å½“å‰æ˜¯å¦ç¡®å®åœ¨å……ç”µã€‚</p>
<p><code>Page_Get_NowPage()-&gt;page_obj != &amp;ui_ChargPage</code>:
æ£€æŸ¥å½“å‰æ˜¯å¦ä¸åœ¨å……ç”µé¡µé¢ã€‚</p>
<p>å¦‚æœâ€œæ­£åœ¨å……ç”µâ€ä¸”â€œä¸åœ¨å……ç”µé¡µé¢â€ï¼Œåˆ™æ‰§è¡Œï¼š</p>
<p><code>Page_Load(&amp;Page_Charg);</code>:
è°ƒç”¨é¡µé¢ç®¡ç†å™¨ï¼ŒåŠ è½½å¹¶æ˜¾ç¤ºå……ç”µé¡µé¢ã€‚</p>
<p><code>else if((!ChargeCheck()) &amp;&amp; (Page_Get_NowPage()-&gt;page_obj == &amp;ui_ChargPage))</code>:</p>
<p><code>!ChargeCheck()</code>:
åˆ¤æ–­å½“å‰æ˜¯å¦æ²¡æœ‰åœ¨å……ç”µï¼ˆæ¯”å¦‚ç”¨æˆ·æ‹”æ‰äº†å……ç”µå™¨ï¼‰ã€‚</p>
<p><code>Page_Get_NowPage()-&gt;page_obj == &amp;ui_ChargPage</code>:
æ£€æŸ¥å½“å‰æ˜¯å¦æ­£å¥½åœ¨å……ç”µé¡µé¢ã€‚</p>
<p>å¦‚æœâ€œæœªåœ¨å……ç”µâ€ä¸”â€œåœ¨å……ç”µé¡µé¢â€ï¼Œåˆ™æ‰§è¡Œï¼š</p>
<p><code>Page_Back();</code>:
è°ƒç”¨é¡µé¢ç®¡ç†å™¨ï¼Œä»å……ç”µé¡µé¢è¿”å›åˆ°ä¹‹å‰çš„é¡µé¢ã€‚</p>
<p><code>osDelay(500);</code>: ä»»åŠ¡æ¯ 500
æ¯«ç§’æ£€æŸ¥ä¸€æ¬¡æ ‡å¿—ä½ã€‚è¿™ä¸ªå»¶æ—¶å†³å®šäº†å“åº”å……ç”µäº‹ä»¶çš„æœ€å¤§å»¶è¿Ÿã€‚</p>
<h3 id="user_messagesendtask">user_MessageSendTask</h3>
<p>è¿™ä¸ªä»»åŠ¡æ˜¯æ‰‹è¡¨ä¸å¤–ç•Œï¼ˆå¦‚æ‰‹æœºè“ç‰™åŠ©æ‰‹ï¼‰è¿›è¡Œæ•°æ®äº¤æ¢çš„çª—å£ã€‚å®ƒè´Ÿè´£è§£ææ”¶åˆ°çš„å‘½ä»¤å­—ç¬¦ä¸²ï¼Œå¹¶æ ¹æ®å‘½ä»¤æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œæ¯”å¦‚è®¾ç½®æ—¶é—´ã€è¿”å›æ‰‹è¡¨çŠ¶æ€ç­‰ã€‚</p>
<p>å…¨å±€å˜é‡ä¸è¾…åŠ©å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct</span><br><span class="line">&#123;</span><br><span class="line">	// ... (æˆå‘˜å˜é‡) ...</span><br><span class="line">&#125;BLEMessage;</span><br><span class="line"></span><br><span class="line">struct</span><br><span class="line">&#123;</span><br><span class="line">	// ... (æˆå‘˜å˜é‡) ...</span><br><span class="line">&#125;TimeSetMessage;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“<code>BLEMessage</code>å’Œ<code>TimeSetMessage</code>ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨è¦å‘é€çš„æ•°æ®æˆ–ä»å­—ç¬¦ä¸²ä¸­è§£æå‡ºçš„æ•°æ®ï¼Œè®©ä»£ç æ›´å…·å¯è¯»æ€§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void StrCMD_Get(uint8_t * str,uint8_t * cmd)</span><br><span class="line">&#123;</span><br><span class="line">	// ... (ä» &quot;CMD=DATA&quot; æ ¼å¼çš„å­—ç¬¦ä¸²ä¸­æå–å‡º &quot;CMD&quot; éƒ¨åˆ†) ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint8_t TimeFormat_Get(uint8_t * str)</span><br><span class="line">&#123;</span><br><span class="line">	// ... (ä» &quot;OV+ST=20230629125555&quot; æ ¼å¼çš„å­—ç¬¦ä¸²ä¸­è§£æå‡ºå¹´æœˆæ—¥æ—¶åˆ†ç§’) ...</span><br><span class="line">	// ... (å¹¶è°ƒç”¨RTCå‡½æ•°è®¾ç½®ç³»ç»Ÿæ—¶é—´) ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StrCMD_Get</code>:
ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºä»æ¥æ”¶åˆ°çš„å­—ç¬¦ä¸²ï¼ˆå¦‚â€CMD=DATAâ€ï¼‰ä¸­æå–å‡ºç­‰å·å‰é¢çš„å‘½ä»¤éƒ¨åˆ†ï¼ˆâ€œCMDâ€ï¼‰ã€‚</p>
<p><code>TimeFormat_Get</code>:
ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä¸“é—¨ç”¨äºè§£æè®¾ç½®æ—¶é—´çš„å‘½ä»¤å­—ç¬¦ä¸²ï¼Œå¹¶å°†è§£æå‡ºçš„æ•°å­—è®¾ç½®åˆ°
RTC ä¸­ã€‚å®ƒè¿˜åŒ…å«æ•°æ®åˆæ³•æ€§æ£€æŸ¥ã€‚</p>
<p><code>MessageSendTask()</code>- ä»»åŠ¡ä¸»å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void MessageSendTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		if(HardInt_uart_flag)</span><br><span class="line">		&#123;</span><br><span class="line">			HardInt_uart_flag = 0;</span><br><span class="line">			uint8_t IdleBreakstr = 0;</span><br><span class="line">			osMessageQueuePut(IdleBreak_MessageQueue,&amp;IdleBreakstr,NULL,1);</span><br><span class="line">			printf(&quot;RecStr:%s\r\n&quot;,HardInt_receive_str);</span><br></pre></td></tr></table></figure>
<p><code>if(HardInt_uart_flag)</code>:
å’Œå……ç”µä»»åŠ¡ç±»ä¼¼ï¼Œå®ƒç”±ä¸€ä¸ªå…¨å±€ä¸­æ–­æ ‡å¿—ä½ HardInt_uart_flag
è§¦å‘ã€‚è¿™ä¸ªæ ‡å¿—ä½åœ¨ä¸²å£ç©ºé—²ä¸­æ–­ï¼ˆIDLE_ITï¼‰çš„æœåŠ¡ç¨‹åºä¸­è¢«è®¾ç½®ï¼Œè¡¨ç¤ºä¸€å¸§æ•°æ®å·²ç»é€šè¿‡
DMA å®Œæ•´æ¥æ”¶åˆ°<code>HardInt_receive_str</code>ç¼“å†²åŒºä¸­ã€‚</p>
<p><code>HardInt_uart_flag = 0;</code>: æ¸…é™¤æ ‡å¿—ä½ã€‚</p>
<p><code>osMessageQueuePut(IdleBreak_MessageQueue, ...)</code>:
ä»»ä½•ä¸²å£é€šä¿¡éƒ½è§†ä¸ºç”¨æˆ·æ´»åŠ¨ï¼Œå‘é€æ¶ˆæ¯ä»¥æ‰“æ–­ç©ºé—²çŠ¶æ€ã€‚</p>
<p><code>printf("RecStr:%s\r\n",HardInt_receive_str);</code>: é€šè¿‡
printfï¼ˆé‡å®šå‘åˆ°ä¸²å£ï¼‰å°†æ”¶åˆ°çš„åŸå§‹å­—ç¬¦ä¸²å›æ˜¾ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if(!strcmp(HardInt_receive_str,&quot;OV&quot;))</span><br><span class="line">&#123;</span><br><span class="line">	printf(&quot;OK\r\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">else if(!strcmp(HardInt_receive_str,&quot;OV+VERSION&quot;))</span><br><span class="line">&#123;</span><br><span class="line">	printf(&quot;VERSION=V%d.%d.%d\r\n&quot;, ...);</span><br><span class="line">&#125;</span><br><span class="line">else if(!strcmp(HardInt_receive_str,&quot;OV+SEND&quot;))</span><br><span class="line">&#123;</span><br><span class="line">             // ... (ä»å„ä¸ªç¡¬ä»¶æ¥å£è·å–å½“å‰çŠ¶æ€æ•°æ®) ...</span><br><span class="line">	// ... (é€šè¿‡printfæ ¼å¼åŒ–è¾“å‡ºæ‰€æœ‰æ•°æ®) ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤è§£æ: ä½¿ç”¨ strcmp å‡½æ•°ï¼ˆå­—ç¬¦ä¸²æ¯”è¾ƒï¼‰æ¥åˆ¤æ–­æ”¶åˆ°çš„å‘½ä»¤æ˜¯ä»€ä¹ˆã€‚</p>
<p>â€œOVâ€: è¿™æ˜¯ä¸€ä¸ªâ€œè¿æ¥æµ‹è¯•â€å‘½ä»¤ï¼Œæ”¶åˆ°åå›å¤â€OKâ€œã€‚</p>
<p>â€œOV+VERSIONâ€: æŸ¥è¯¢ç‰ˆæœ¬å·å‘½ä»¤ï¼Œå›å¤æ ¼å¼åŒ–çš„ç‰ˆæœ¬å·å­—ç¬¦ä¸²ã€‚</p>
<p>â€œOV+SENDâ€: è¯·æ±‚æ‰‹è¡¨å½“å‰æ‰€æœ‰çŠ¶æ€æ•°æ®çš„å‘½ä»¤ã€‚ä»£ç ä¼šä» RTCã€HWInterface
ç­‰å¤„è·å–æ—¶é—´ã€æ¸©æ¹¿åº¦ã€å¿ƒç‡ã€è¡€æ°§ã€æ­¥æ•°ç­‰ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ä¸€ç³»åˆ— printf
å‘é€å‡ºå»ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//set time//OV+ST=20230629125555</span><br><span class="line">else if(strlen(HardInt_receive_str)==20)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t cmd[10];</span><br><span class="line">	memset(cmd,0,sizeof(cmd));</span><br><span class="line">	StrCMD_Get(HardInt_receive_str,cmd);</span><br><span class="line">	if(ui_APPSy_EN &amp;&amp; !strcmp(cmd,&quot;OV+ST&quot;))</span><br><span class="line">	&#123;</span><br><span class="line">		TimeFormat_Get(HardInt_receive_str);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®æ—¶é—´å‘½ä»¤è§£æ:</p>
<p><code>if(strlen(HardInt_receive_str)==20)</code>:
é€šè¿‡åˆ¤æ–­å­—ç¬¦ä¸²é•¿åº¦ï¼ˆ20
ä¸ªå­—ç¬¦ï¼‰æ¥å¿«é€Ÿè¯†åˆ«è¿™å¯èƒ½æ˜¯ä¸€ä¸ªè®¾ç½®æ—¶é—´çš„å‘½ä»¤ã€‚</p>
<p><code>StrCMD_Get(...)</code>: è°ƒç”¨è¾…åŠ©å‡½æ•°æå–å‘½ä»¤éƒ¨åˆ†ã€‚</p>
<p><code>if(ui_APPSy_EN &amp;&amp; !strcmp(cmd,"OV+ST"))</code>:
æ£€æŸ¥â€œå…è®¸ APP
åŒæ­¥â€çš„å¼€å…³ï¼ˆui_APPSy_ENï¼‰æ˜¯å¦æ‰“å¼€ï¼Œå¹¶ä¸”å‘½ä»¤æ˜¯å¦æ˜¯â€OV+STâ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TimeFormat_Get(HardInt_receive_str);: å¦‚æœæ¡ä»¶éƒ½æ»¡è¶³ï¼Œåˆ™è°ƒç”¨æ—¶é—´è§£æå‡½æ•°æ¥å®Œæˆæ—¶é—´è®¾ç½®ã€‚</span><br><span class="line"></span><br><span class="line">			memset(HardInt_receive_str,0,sizeof(HardInt_receive_str));</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(1000);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>memset(...)</code>:
åœ¨å¤„ç†å®Œä¸€æ¬¡å‘½ä»¤åï¼Œæ¸…ç©ºæ¥æ”¶ç¼“å†²åŒºï¼Œä¸ºä¸‹ä¸€æ¬¡æ¥æ”¶åšå‡†å¤‡ã€‚</p>
<p><code>osDelay(1000);</code>: å¦‚æœæ²¡æœ‰ä¸­æ–­æ ‡å¿—ï¼Œä»»åŠ¡ä¼šåœ¨æ­¤å»¶æ—¶ 1
ç§’ï¼ŒCPU å ç”¨ç‡å¾ˆä½ã€‚</p>
<h3 id="user_sensupdatetask">user_SensUpdateTask</h3>
<p>è¿™ä¸ªæ–‡ä»¶æ˜¯æ‰‹è¡¨çš„â€œæ„ŸçŸ¥ä¸­å¿ƒâ€ï¼Œè´Ÿè´£ä»å„ç§ä¼ æ„Ÿå™¨æ”¶é›†åŸå§‹æ•°æ®ï¼Œè¿›è¡Œå¤„ç†ï¼Œå¹¶æ›´æ–°åˆ°ç³»ç»Ÿçš„å…¨å±€æ•°æ®æ¥å£ï¼ˆHWInterfaceï¼‰ä¸­ï¼Œä¾›
UI æˆ–å…¶ä»–ä»»åŠ¡ä½¿ç”¨ã€‚å®ƒåŒ…å«äº†ä¸‰ä¸ªç‹¬ç«‹çš„ä»»åŠ¡ï¼šMPUCheckTask,
HRDataUpdateTask, å’Œ SensorDataUpdateTaskã€‚</p>
<p><code>MPUCheckTask()</code> - MPU6050 çŠ¶æ€æ£€æŸ¥ä»»åŠ¡ (æŠ¬è…•æ£€æµ‹)
è¿™ä¸ªä»»åŠ¡ä¸“é—¨ç”¨äºå®ç°â€œæŠ¬è…•äº®å±â€å’Œâ€œæ”¾è…•æ¯å±â€çš„åŠŸèƒ½ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">void MPUCheckTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		if(HWInterface.IMU.wrist_is_enabled)</span><br><span class="line">		&#123;</span><br><span class="line">			if(MPU_isHorizontal())</span><br><span class="line">			&#123;</span><br><span class="line">				HWInterface.IMU.wrist_state = WRIST_UP;</span><br><span class="line">			&#125;</span><br><span class="line">			else</span><br><span class="line">			&#123;</span><br><span class="line">				if(WRIST_UP == HWInterface.IMU.wrist_state)</span><br><span class="line">				&#123;</span><br><span class="line">					HWInterface.IMU.wrist_state = WRIST_DOWN;</span><br><span class="line">					if( Page_Get_NowPage()-&gt;page_obj == &amp;ui_HomePage ||</span><br><span class="line">						Page_Get_NowPage()-&gt;page_obj == &amp;ui_MenuPage ||</span><br><span class="line">						Page_Get_NowPage()-&gt;page_obj == &amp;ui_SetPage )</span><br><span class="line">					&#123;</span><br><span class="line">						uint8_t Stopstr;</span><br><span class="line">						osMessageQueuePut(Stop_MessageQueue, &amp;Stopstr, 0, 1);//sleep</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				HWInterface.IMU.wrist_state = WRIST_DOWN;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(300);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>if(HWInterface.IMU.wrist_is_enabled)</code>:
é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨è®¾ç½®ä¸­å¼€å¯äº†â€œæŠ¬è…•äº®å±â€åŠŸèƒ½ã€‚å¦‚æœæ²¡å¼€å¯ï¼Œä»»åŠ¡å°†ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p>
<p><code>if(MPU_isHorizontal())</code>: è°ƒç”¨ MPU6050
é©±åŠ¨ä¸­çš„å‡½æ•°ï¼Œåˆ¤æ–­æ‰‹è¡¨å½“å‰æ˜¯å¦å¤„äºæ°´å¹³çŠ¶æ€ã€‚</p>
<p><code>HWInterface.IMU.wrist_state = WRIST_UP;</code>:
å¦‚æœæ˜¯æ°´å¹³çš„ï¼Œå°±å°†æ‰‹è…•çŠ¶æ€æ ‡è®°ä¸º WRIST_UPï¼ˆæŠ¬èµ·ï¼‰ã€‚</p>
<p><code>if(WRIST_UP == HWInterface.IMU.wrist_state)</code>:
åˆ¤æ–­ä¸Šä¸€ä¸ªçŠ¶æ€æ˜¯å¦æ˜¯
WRIST_UPã€‚è¿™ä¸ªåˆ¤æ–­éå¸¸å…³é”®ï¼Œå®ƒç¡®ä¿äº†åªæœ‰åœ¨â€œä»æŠ¬èµ·åˆ°æ”¾ä¸‹â€è¿™ä¸ªç¬é—´æ‰ä¼šæ‰§è¡Œæ¯å±é€»è¾‘ã€‚</p>
<p><code>HWInterface.IMU.wrist_state = WRIST_DOWN;</code>:
å°†å½“å‰çŠ¶æ€æ›´æ–°ä¸º WRIST_DOWNã€‚</p>
<p><code>if( Page_Get_NowPage()-&gt;page_obj == ... )</code>:
æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨ä¸»é¡µã€èœå•é¡µæˆ–è®¾ç½®é¡µã€‚åªæœ‰åœ¨è¿™äº›éè¿åŠ¨ã€éä¸“æ³¨æ¨¡å¼çš„é¡µé¢ä¸‹ï¼Œæ”¾ä¸‹æ‰‹è…•æ‰ä¼šè§¦å‘æ¯å±ã€‚</p>
<p><code>osMessageQueuePut(Stop_MessageQueue, ...)</code>:
å‘é€æ¶ˆæ¯ï¼Œé€šçŸ¥ StopEnterTask è®©ç³»ç»Ÿè¿›å…¥ä¼‘çœ ã€‚</p>
<p><code>osDelay(300);</code>: æ¯ 300 æ¯«ç§’æ£€æŸ¥ä¸€æ¬¡æ‰‹è…•çŠ¶æ€ã€‚</p>
<p><code>HRDataUpdateTask()</code> - å¿ƒç‡æ•°æ®æ›´æ–°ä»»åŠ¡
è¿™ä¸ªä»»åŠ¡ä¸“é—¨è´Ÿè´£åœ¨å¿ƒç‡æµ‹é‡é¡µé¢æŒç»­è¯»å–å’Œè®¡ç®—å¿ƒç‡å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">void HRDataUpdateTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t IdleBreakstr=0;</span><br><span class="line">	uint16_t dat=0;</span><br><span class="line">	uint8_t hr_temp=0;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_HRPage)</span><br><span class="line">		&#123;</span><br><span class="line">			osMessageQueuePut(IdleBreak_MessageQueue, &amp;IdleBreakstr, 0, 1);</span><br><span class="line">			//sensor wake up</span><br><span class="line">			EM7028_hrs_Enable();</span><br><span class="line">			if(!HWInterface.HR_meter.ConnectionError)</span><br><span class="line">			&#123;</span><br><span class="line">				//Hr messure</span><br><span class="line">				vTaskSuspendAll();</span><br><span class="line">				hr_temp = HR_Calculate(EM7028_Get_HRS1(),user_HR_timecount);</span><br><span class="line">				xTaskResumeAll();</span><br><span class="line">				if(HWInterface.HR_meter.HrRate != hr_temp &amp;&amp; hr_temp&gt;50 &amp;&amp; hr_temp&lt;120)</span><br><span class="line">				&#123;</span><br><span class="line">					HWInterface.HR_meter.HrRate = hr_temp;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(50);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_HRPage)</code>:
ä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘åªæœ‰åœ¨ç”¨æˆ·è¿›å…¥äº†å¿ƒç‡é¡µé¢æ—¶æ‰ä¼šè¢«æ¿€æ´»ã€‚è¿™æ˜¯ä¸€ç§éå¸¸é«˜æ•ˆçš„èŠ‚èƒ½ç­–ç•¥ã€‚</p>
<p><code>osMessageQueuePut(IdleBreak_MessageQueue, ...)</code>:
åªè¦åœ¨å¿ƒç‡é¡µé¢ï¼Œå°±æŒç»­å‘é€â€œç©ºé—²ä¸­æ–­â€æ¶ˆæ¯ï¼Œé˜²æ­¢æ‰‹è¡¨è‡ªåŠ¨æ¯å±ã€‚</p>
<p><code>EM7028_hrs_Enable();</code>: å”¤é†’å¿ƒç‡ä¼ æ„Ÿå™¨ã€‚</p>
<p><code>if(!HWInterface.HR_meter.ConnectionError)</code>:
æ£€æŸ¥å¿ƒç‡ä¼ æ„Ÿå™¨æ˜¯å¦è¿æ¥æ­£å¸¸ã€‚</p>
<p><code>vTaskSuspendAll(); ... xTaskResumeAll();</code>:
åœ¨è°ƒç”¨å¿ƒç‡è®¡ç®—å‡½æ•° HR_Calculate
å‰åï¼ŒæŒ‚èµ·å’Œæ¢å¤ä»»åŠ¡è°ƒåº¦å™¨ã€‚è¿™å¯èƒ½æ˜¯ä¸ºäº†ä¿è¯è¯»å–ä¼ æ„Ÿå™¨åŸå§‹å€¼å’Œæ—¶é—´æˆ³
user_HR_timecount çš„åŸå­æ€§ã€‚</p>
<p><code>hr_temp = HR_Calculate(...)</code>:
è°ƒç”¨å¿ƒç‡è®¡ç®—ç®—æ³•ï¼Œä¼ å…¥ä»ä¼ æ„Ÿå™¨è¯»åˆ°çš„åŸå§‹å€¼å’Œè®¡æ—¶å™¨å€¼ï¼Œå¾—åˆ°è®¡ç®—åçš„å¿ƒç‡ã€‚</p>
<p><code>if( ... &amp;&amp; hr_temp&gt;50 &amp;&amp; hr_temp&lt;120)</code>:
å¯¹è®¡ç®—ç»“æœè¿›è¡Œåˆç†æ€§æ£€æŸ¥ï¼Œè¿‡æ»¤æ‰æ˜æ˜¾çš„å¼‚å¸¸å€¼ã€‚</p>
<p><code>HWInterface.HR_meter.HrRate = hr_temp</code>;:
å°†æœ‰æ•ˆçš„å¿ƒç‡å€¼æ›´æ–°åˆ°å…¨å±€ç¡¬ä»¶æ¥å£ä¸­ï¼ŒUI ä¼šè‡ªåŠ¨ä»è¿™é‡Œè¯»å–å¹¶æ˜¾ç¤ºã€‚</p>
<p><code>osDelay(50);</code>: æ¯ 50 æ¯«ç§’è¿›è¡Œä¸€æ¬¡å¿ƒç‡è®¡ç®—å’Œæ›´æ–°ã€‚</p>
<p><code>SensorDataUpdateTask()</code> - é€šç”¨ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°ä»»åŠ¡
è¿™æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„ä»»åŠ¡ï¼Œè´Ÿè´£å¤„ç†å¤šç§åœºæ™¯ä¸‹çš„ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">void SensorDataUpdateTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	// ...</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		// Update the sens data showed in Home</span><br><span class="line">		uint8_t HomeUpdataStr;</span><br><span class="line">		if(osMessageQueueGet(HomeUpdata_MessageQueue, &amp;HomeUpdataStr, NULL, 0)==osOK)</span><br><span class="line">		&#123;</span><br><span class="line">            // ... (è®¡ç®—ç”µé‡ã€è·å–æ­¥æ•°ã€æ¸©æ¹¿åº¦) ...</span><br><span class="line">			//send data save message queue</span><br><span class="line">			uint8_t Datastr = 3;</span><br><span class="line">			osMessageQueuePut(DataSave_MessageQueue, &amp;Datastr, 0, 1);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// SPO2 Page</span><br><span class="line">		if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_SPO2Page)</span><br><span class="line">		&#123;</span><br><span class="line">			// ... (è¡€æ°§æµ‹é‡é€»è¾‘) ...</span><br><span class="line">		&#125;</span><br><span class="line">		// Env Page</span><br><span class="line">		else if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_EnvPage)</span><br><span class="line">		&#123;</span><br><span class="line">			// ... (ç¯å¢ƒæ¸©æ¹¿åº¦æµ‹é‡é€»è¾‘) ...</span><br><span class="line">		&#125;</span><br><span class="line">		// Compass page</span><br><span class="line">		else if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_CompassPage)</span><br><span class="line">		&#123;</span><br><span class="line">			// ... (ç”µå­ç½—ç›˜å’Œæ°”å‹è®¡æµ‹é‡é€»è¾‘) ...</span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(500);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>if(osMessageQueueGet(HomeUpdata_MessageQueue, ...)==osOK)</code>:
åœºæ™¯ä¸€ï¼šæ›´æ–°ä¸»é¡µæ•°æ®ã€‚</p>
<p>è¿™ä¸ªä»»åŠ¡ä¼šç­‰å¾… HomeUpdata_MessageQueue
çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæ¶ˆæ¯åœ¨ç³»ç»Ÿåˆšå”¤é†’æˆ–éœ€è¦å¼ºåˆ¶åˆ·æ–°æ•°æ®æ—¶è¢«å‘é€ã€‚</p>
<p>æ”¶åˆ°æ¶ˆæ¯åï¼Œå®ƒä¼šæ‰§è¡Œä¸€ç³»åˆ—æ•°æ®æ›´æ–°æ“ä½œï¼š</p>
<p><code>HWInterface.Power.BatCalculate()</code>: è®¡ç®—ç”µæ± å‰©ä½™ç”µé‡ã€‚</p>
<p><code>HWInterface.IMU.GetSteps()</code>: è·å–å½“å‰çš„æ€»æ­¥æ•°ã€‚</p>
<p><code>HWInterface.AHT21.GetHumiTemp(...)</code>: è·å–æ¸©æ¹¿åº¦ã€‚</p>
<p><code>osMessageQueuePut(DataSave_MessageQueue, ...)</code>:
åœ¨æ›´æ–°å®Œä¸»é¡µæ•°æ®åï¼Œå‘é€ä¸€ä¸ªæ¶ˆæ¯ç»™
DataSaveTaskï¼Œé€šçŸ¥å®ƒå°†æœ€æ–°çš„æ­¥æ•°ç­‰ä¿¡æ¯ä¿å­˜åˆ° EEPROM ä¸­ã€‚</p>
<p><code>if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_SPO2Page)</code>:
å¦‚æœåœ¨è¡€æ°§é¡µé¢ï¼Œæ‰§è¡Œè¡€æ°§æµ‹é‡é€»è¾‘ã€‚</p>
<p><code>else if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_EnvPage)</code>:
å¦‚æœåœ¨ç¯å¢ƒé¡µé¢ï¼Œæ‰§è¡Œæ¸©æ¹¿åº¦æµ‹é‡é€»è¾‘ã€‚</p>
<p><code>else if(Page_Get_NowPage()-&gt;page_obj == &amp;ui_CompassPage)</code>:
å¦‚æœåœ¨ç½—ç›˜é¡µé¢ï¼Œåˆ™å”¤é†’å¹¶è¯»å–ç”µå­ç½—ç›˜å’Œæ°”å‹è®¡çš„æ•°æ®ã€‚</p>
<p>è¿™ä¸ªæ–‡ä»¶çš„è®¾è®¡å……åˆ†ä½“ç°äº†æŒ‰éœ€æ›´æ–°å’ŒèŠ‚èƒ½çš„æ€æƒ³ã€‚å¤§éƒ¨åˆ†ä¼ æ„Ÿå™¨çš„è€—ç”µè¡Œä¸ºéƒ½ä¸å½“å‰
UI
é¡µé¢ç»‘å®šï¼Œåªæœ‰åœ¨éœ€è¦æ˜¾ç¤ºè¯¥æ•°æ®æ—¶ï¼Œå¯¹åº”çš„ä»»åŠ¡é€»è¾‘æ‰ä¼šè¢«æ¿€æ´»ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°å»¶é•¿äº†ç”µæ± ç»­èˆªã€‚</p>
<h3 id="user_datasavetask">user_DataSaveTask</h3>
<p>è¿™ä¸ªä»»åŠ¡çš„èŒè´£æ˜¯å°†é‡è¦çš„ç”¨æˆ·æ•°æ®å’Œè®¾ç½®å†™å…¥åˆ° EEPROM
ä¸­ï¼Œä»¥å®ç°æ–­ç”µåæ•°æ®ä¸ä¸¢å¤±ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰ã€‚å®ƒæ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ä»»åŠ¡ï¼Œä¸“é—¨ç­‰å¾…æ¥è‡ªå…¶ä»–ä»»åŠ¡çš„â€œä¿å­˜æ•°æ®â€è¯·æ±‚ã€‚</p>
<p>EEPROM æ•°æ®ç»“æ„è¯´æ˜ åœ¨ä»£ç æ³¨é‡Šä¸­ï¼Œæ¸…æ™°åœ°è¯´æ˜äº† EEPROM
ä¸­å­˜å‚¨çš„æ•°æ®æ ¼å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/******************************************</span><br><span class="line">EEPROM Data description:</span><br><span class="line">[0x00]:0x55 for check</span><br><span class="line">[0x01]:0xAA for check</span><br><span class="line"></span><br><span class="line">[0x10]:user wrist setting, HWInterface.IMU.wrist_is_enabled</span><br><span class="line">[0x11]:user ui_APPSy_EN setting</span><br><span class="line"></span><br><span class="line">[0x20]:Last Save Day(0-31)</span><br><span class="line">[0x21]:Day Steps</span><br><span class="line"></span><br><span class="line">*******************************************/</span><br></pre></td></tr></table></figure>
<p><code>0x00</code>, <code>0x01</code>: å­˜å‚¨å›ºå®šçš„æ ¡éªŒç 
0x55AAï¼Œç”¨äºä¸Šç”µæ—¶åˆ¤æ–­ EEPROM ä¸­çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚</p>
<p><code>0x10</code>: å­˜å‚¨â€œæŠ¬è…•äº®å±â€åŠŸèƒ½çš„å¼€å…³çŠ¶æ€ã€‚</p>
<p><code>0x11</code>: å­˜å‚¨â€œå…è®¸ APP åŒæ­¥â€åŠŸèƒ½çš„å¼€å…³çŠ¶æ€ã€‚</p>
<p><code>0x20</code>: å­˜å‚¨ä¸Šä¸€æ¬¡ä¿å­˜æ•°æ®æ—¶çš„æ—¥æœŸï¼ˆå‡ å·ï¼‰ã€‚</p>
<p><code>0x21</code>, <code>0x22</code>: å­˜å‚¨å½“å¤©çš„æ€»æ­¥æ•°ï¼ˆä¸€ä¸ª 16
ä½çš„æ•°ï¼Œéœ€è¦ä¸¤ä¸ªå­—èŠ‚ï¼‰ã€‚</p>
<p>ä»»åŠ¡æ‰§è¡Œæµç¨‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">void DataSaveTask(void *argument)</span><br><span class="line">&#123;</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		uint8_t Datastr=0;</span><br><span class="line">		if(osMessageQueueGet(DataSave_MessageQueue,&amp;Datastr,NULL,1)==osOK)</span><br><span class="line">		&#123;</span><br><span class="line">			/****************</span><br><span class="line">			Setting change</span><br><span class="line">			date change</span><br><span class="line">			Step change</span><br><span class="line">			****************/</span><br><span class="line">			uint8_t dat[3];</span><br><span class="line">			dat[0] = HWInterface.IMU.wrist_is_enabled;</span><br><span class="line">			dat[1] = ui_APPSy_EN;</span><br><span class="line">			SettingSave(dat,0x10,2);</span><br><span class="line"></span><br><span class="line">			RTC_DateTypeDef nowdate;</span><br><span class="line">			HAL_RTC_GetDate(&amp;hrtc,&amp;nowdate,RTC_FORMAT_BIN);</span><br><span class="line"></span><br><span class="line">			SettingGet(dat,0x20,3);</span><br><span class="line">			if(dat[0] != nowdate.Date)</span><br><span class="line">			&#123;</span><br><span class="line">				if(!HWInterface.IMU.ConnectionError)</span><br><span class="line">					HWInterface.IMU.SetSteps(0);</span><br><span class="line"></span><br><span class="line">				dat[0] = nowdate.Date;</span><br><span class="line">				dat[2] = 0;</span><br><span class="line">				dat[1] = 0;</span><br><span class="line">				SettingSave(dat,0x20,3);</span><br><span class="line">			&#125;</span><br><span class="line">			else</span><br><span class="line">			&#123;</span><br><span class="line">				uint16_t temp = HWInterface.IMU.GetSteps();</span><br><span class="line">				dat[0] = nowdate.Date;</span><br><span class="line">				dat[2] = temp &amp; 0xff;</span><br><span class="line">				dat[1] = temp&gt;&gt;8 &amp; 0xff;</span><br><span class="line">				SettingSave(dat,0x20,3);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		osDelay(100);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>if(osMessageQueueGet(DataSave_MessageQueue, ...)==osOK)</code>:
ä»»åŠ¡çš„æ ¸å¿ƒï¼Œç­‰å¾…ä»<code>DataSave_MessageQueue</code>ä¸­è·å–æ¶ˆæ¯ã€‚è¿™ä¸ªæ¶ˆæ¯ç”±
SensorDataUpdateTask åœ¨æ›´æ–°å®Œä¸»é¡µæ•°æ®åå‘é€ã€‚</p>
<p>ä¿å­˜ç”¨æˆ·è®¾ç½®:</p>
<p><code>dat[0] = HWInterface.IMU.wrist_is_enabled;</code>:
ä»ç¡¬ä»¶æ¥å£è·å–â€œæŠ¬è…•äº®å±â€çš„å½“å‰è®¾ç½®ã€‚</p>
<p><code>dat[1] = ui_APPSy_EN;</code>: è·å–â€œå…è®¸ APP
åŒæ­¥â€çš„å½“å‰è®¾ç½®ã€‚</p>
<p><code>SettingSave(dat, 0x10, 2);</code>: è°ƒç”¨åº•å±‚çš„ EEPROM
å†™å…¥å‡½æ•°ï¼Œå°†è¿™ä¸¤ä¸ªå­—èŠ‚çš„è®¾ç½®æ•°æ®å†™å…¥åˆ°ä»åœ°å€<code>0x10</code>å¼€å§‹çš„ä½ç½®ã€‚</p>
<p>ä¿å­˜æ­¥æ•°ï¼ˆåŒ…å«æ—¥æœŸåˆ‡æ¢é€»è¾‘ï¼‰:</p>
<p><code>HAL_RTC_GetDate(&amp;hrtc, &amp;nowdate, RTC_FORMAT_BIN);</code>:
è·å–å½“å‰çš„æ—¥æœŸã€‚</p>
<p><code>SettingGet(dat, 0x20, 3);</code>: ä» EEPROM
ä¸­è¯»å‡ºä¸Šæ¬¡ä¿å­˜çš„æ—¥æœŸå’Œæ­¥æ•°ã€‚</p>
<p><code>if(dat[0] != nowdate.Date)</code>:
åˆ¤æ–­æ—¥æœŸæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼ˆå³æ˜¯å¦è¿›å…¥äº†æ–°çš„ä¸€å¤©ï¼‰ã€‚</p>
<p>å¦‚æœæ—¥æœŸå˜äº†ï¼ˆæ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼‰ï¼š</p>
<p><code>HWInterface.IMU.SetSteps(0);</code>: å°† MPU6050
å†…éƒ¨çš„è®¡æ­¥å™¨æ¸…é›¶ã€‚</p>
<p><code>dat[0] = nowdate.Date; dat[1]=0; dat[2]=0;</code>: å‡†å¤‡è¦å†™å…¥
EEPROM çš„æ–°æ•°æ®ï¼šä»Šå¤©çš„æ—¥æœŸå’Œæ¸…é›¶åçš„æ­¥æ•°ã€‚</p>
<p><code>SettingSave(dat, 0x20, 3);</code>: å°†æ–°æ•°æ®å†™å…¥ EEPROMã€‚</p>
<p>å¦‚æœæ—¥æœŸæ²¡å˜ï¼ˆè¿˜æ˜¯ä»Šå¤©ï¼‰ã€‚</p>
<p><code>uint16_t temp = HWInterface.IMU.GetSteps();</code>:
è·å–å½“å‰çš„æœ€æ–°æ­¥æ•°ã€‚</p>
<p><code>dat[0] = nowdate.Date;</code> â€¦:
å‡†å¤‡è¦å†™å…¥çš„æ•°æ®ï¼šä»Šå¤©çš„æ—¥æœŸå’Œæœ€æ–°çš„æ­¥æ•°ã€‚</p>
<p><code>SettingSave(dat, 0x20, 3);</code>: å°†æœ€æ–°çš„æ­¥æ•°æ›´æ–°åˆ° EEPROM
ä¸­ã€‚</p>
<p><code>osDelay(100);</code>: å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œä»»åŠ¡å»¶æ—¶ 100 æ¯«ç§’ã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%A4%8D%E5%88%BB/" rel="tag"># å¤åˆ»</a>
              <a href="/tags/STM32/" rel="tag"># STM32</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/08/04/RTOS/" rel="prev" title="RTOSå­¦ä¹ ç¬”è®°ï¼ˆFromå°šç¡…è°·ï¼‰">
      <i class="fa fa-chevron-left"></i> RTOSå­¦ä¹ ç¬”è®°ï¼ˆFromå°šç¡…è°·ï¼‰
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/08/17/LVGL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="next" title="LVGLå­¦ä¹ ç¬”è®°">
      LVGLå­¦ä¹ ç¬”è®° <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6"><span class="nav-number">1.</span> <span class="nav-text">æ•´ä½“æ¡†æ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">ç¡¬ä»¶ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90"><span class="nav-number">1.1.1.</span> <span class="nav-text">ç³»ç»Ÿç»„æˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9B%E7%94%B5%E9%83%A8%E5%88%86"><span class="nav-number">1.1.2.</span> <span class="nav-text">ä¾›ç”µéƒ¨åˆ†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%85%E7%94%B5%E9%83%A8%E5%88%86"><span class="nav-number">1.1.3.</span> <span class="nav-text">å……ç”µéƒ¨åˆ†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-%E6%80%BB%E7%BA%BF"><span class="nav-number">1.1.4.</span> <span class="nav-text">I2C æ€»çº¿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mpu-6050"><span class="nav-number">1.1.5.</span> <span class="nav-text">MPU-6050</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spl06-001-%E6%95%B0%E5%AD%97%E6%B0%94%E5%8E%8B%E4%BC%A0%E6%84%9F%E5%99%A8"><span class="nav-number">1.1.6.</span> <span class="nav-text">SPL06-001 æ•°å­—æ°”å‹ä¼ æ„Ÿå™¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aht21b-%E6%B8%A9%E6%B9%BF%E5%BA%A6%E4%BC%A0%E6%84%9F%E5%99%A8"><span class="nav-number">1.1.7.</span> <span class="nav-text">AHT21B æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lsm303dlhc-%E6%8C%87%E5%8D%97%E9%92%88%E6%A8%A1%E5%9D%97"><span class="nav-number">1.1.8.</span> <span class="nav-text">LSM303DLHC æŒ‡å—é’ˆæ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#em7028-%E5%BF%83%E7%8E%87%E6%A3%80%E6%B5%8B"><span class="nav-number">1.1.9.</span> <span class="nav-text">EM7028 å¿ƒç‡æ£€æµ‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%93%9D%E7%89%99"><span class="nav-number">1.1.10.</span> <span class="nav-text">è“ç‰™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stm32f411ceu6"><span class="nav-number">1.1.11.</span> <span class="nav-text">STM32F411CEU6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9B%E7%94%B5%E9%83%A8%E5%88%86-1"><span class="nav-number">1.1.12.</span> <span class="nav-text">ä¾›ç”µéƒ¨åˆ†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%85%E7%94%B5%E9%83%A8%E5%88%86-1"><span class="nav-number">1.1.13.</span> <span class="nav-text">å……ç”µéƒ¨åˆ†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#eeprom-%E5%92%8C%E7%9C%8B%E9%97%A8%E7%8B%97"><span class="nav-number">1.1.14.</span> <span class="nav-text">EEPROM å’Œçœ‹é—¨ç‹—</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6%E6%A1%86%E6%9E%B6"><span class="nav-number">1.2.</span> <span class="nav-text">è½¯ä»¶æ¡†æ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mdk-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.1.</span> <span class="nav-text">MDK å·¥ç¨‹ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cubemx-%E6%A1%86%E6%9E%B6"><span class="nav-number">1.2.2.</span> <span class="nav-text">CubeMX æ¡†æ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%BF%E8%BD%BD%E9%A9%B1%E5%8A%A8-bsp"><span class="nav-number">1.2.3.</span> <span class="nav-text">æ¿è½½é©±åŠ¨ BSP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E8%AE%BF%E9%97%AE%E6%9C%BA%E5%88%B6-hwdataaccess"><span class="nav-number">1.2.4.</span> <span class="nav-text">ç¡¬ä»¶è®¿é—®æœºåˆ¶-HWDataAccess</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lvgl-%E9%A1%B5%E9%9D%A2%E7%AE%A1%E7%90%86-pagemanager"><span class="nav-number">1.2.5.</span> <span class="nav-text">LVGL é¡µé¢ç®¡ç†-PageManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BB%BB%E5%8A%A1"><span class="nav-number">1.2.6.</span> <span class="nav-text">å¤šçº¿ç¨‹ä»»åŠ¡</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ui-%E4%B8%8E%E9%A1%B5%E9%9D%A2%E7%AE%A1%E7%90%86-lvgl-pagemanager"><span class="nav-number">2.</span> <span class="nav-text">UI ä¸é¡µé¢ç®¡ç† (LVGL &amp;
PageManager)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BB%BB%E5%8A%A1-freertos-tasks"><span class="nav-number">3.</span> <span class="nav-text">å¤šçº¿ç¨‹ä»»åŠ¡ (FreeRTOS Tasks)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#user_taskslnit"><span class="nav-number">3.1.</span> <span class="nav-text">user_Taskslnit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E5%8F%A5%E6%9F%84%E5%AE%9A%E4%B9%89"><span class="nav-number">3.1.1.</span> <span class="nav-text">ä»»åŠ¡å¥æŸ„å®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9A%E4%B9%89"><span class="nav-number">3.1.2.</span> <span class="nav-text">æ¶ˆæ¯é˜Ÿåˆ—å®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_tasks_init---%E6%80%BB%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0"><span class="nav-number">3.1.3.</span> <span class="nav-text">User_Tasks_Init() -
æ€»åˆå§‹åŒ–å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tasktickhook---%E7%B3%BB%E7%BB%9F%E8%8A%82%E6%8B%8D%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="nav-number">3.1.4.</span> <span class="nav-text">TaskTickHook() -
ç³»ç»ŸèŠ‚æ‹é’©å­å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lvhandlertask-%E5%92%8C-wdogfeedtask"><span class="nav-number">3.1.5.</span> <span class="nav-text">LvHandlerTask() å’Œ
WDOGFeedTask()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_hardwareinittask"><span class="nav-number">3.1.6.</span> <span class="nav-text">user_HardwareInitTask</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#user_runmodetasks"><span class="nav-number">3.2.</span> <span class="nav-text">user_RunModeTasks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#idletimercallback---%E7%A9%BA%E9%97%B2%E5%AE%9A%E6%97%B6%E5%99%A8%E5%9B%9E%E8%B0%83"><span class="nav-number">3.2.1.</span> <span class="nav-text">1. IdleTimerCallback() -
ç©ºé—²å®šæ—¶å™¨å›è°ƒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#idleentertask---%E7%A9%BA%E9%97%B2%E6%A8%A1%E5%BC%8F%E4%BB%BB%E5%8A%A1"><span class="nav-number">3.2.2.</span> <span class="nav-text">2. IdleEnterTask() -
ç©ºé—²æ¨¡å¼ä»»åŠ¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stopentertask---%E5%81%9C%E6%AD%A2%E4%BC%91%E7%9C%A0%E6%A8%A1%E5%BC%8F%E4%BB%BB%E5%8A%A1"><span class="nav-number">3.2.3.</span> <span class="nav-text">3. StopEnterTask() -
åœæ­¢ï¼ˆä¼‘çœ ï¼‰æ¨¡å¼ä»»åŠ¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_keytask"><span class="nav-number">3.2.4.</span> <span class="nav-text">user_KeyTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_scrrenewtask"><span class="nav-number">3.2.5.</span> <span class="nav-text">user_ScrRenewTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_chargchecktask"><span class="nav-number">3.2.6.</span> <span class="nav-text">user_ChargCheckTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_messagesendtask"><span class="nav-number">3.2.7.</span> <span class="nav-text">user_MessageSendTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_sensupdatetask"><span class="nav-number">3.2.8.</span> <span class="nav-text">user_SensUpdateTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user_datasavetask"><span class="nav-number">3.2.9.</span> <span class="nav-text">user_DataSaveTask</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CYZ"
      src="/images/chino2.jpg">
  <p class="site-author-name" itemprop="name">CYZ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/CYZ2024" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;CYZ2024" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/241180180@smail.nju.edu.cn" title="E-Mail â†’ 241180180@smail.nju.edu.cn"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CYZ</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
